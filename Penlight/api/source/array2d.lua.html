<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Penlight Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Penlight</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../source/app.lua.html">app.lua</a></li>
  <li><strong>array2d.lua</strong></li>
  <li><a href="../source/class.lua.html">class.lua</a></li>
  <li><a href="../source/compat.lua.html">compat.lua</a></li>
  <li><a href="../source/comprehension.lua.html">comprehension.lua</a></li>
  <li><a href="../source/config.lua.html">config.lua</a></li>
  <li><a href="../source/data.lua.html">data.lua</a></li>
  <li><a href="../source/date.lua.html">date.lua</a></li>
  <li><a href="../source/dir.lua.html">dir.lua</a></li>
  <li><a href="../source/file.lua.html">file.lua</a></li>
  <li><a href="../source/func.lua.html">func.lua</a></li>
  <li><a href="../source/import_into.lua.html">import_into.lua</a></li>
  <li><a href="../source/init.lua.html">init.lua</a></li>
  <li><a href="../source/input.lua.html">input.lua</a></li>
  <li><a href="../source/lapp.lua.html">lapp.lua</a></li>
  <li><a href="../source/lexer.lua.html">lexer.lua</a></li>
  <li><a href="../source/list.lua.html">list.lua</a></li>
  <li><a href="../source/luabalanced.lua.html">luabalanced.lua</a></li>
  <li><a href="../source/map.lua.html">map.lua</a></li>
  <li><a href="../source/multimap.lua.html">multimap.lua</a></li>
  <li><a href="../source/operator.lua.html">operator.lua</a></li>
  <li><a href="../source/orderedmap.lua.html">orderedmap.lua</a></li>
  <li><a href="../source/path.lua.html">path.lua</a></li>
  <li><a href="../source/permute.lua.html">permute.lua</a></li>
  <li><a href="../source/pretty.lua.html">pretty.lua</a></li>
  <li><a href="../source/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../source/seq.lua.html">seq.lua</a></li>
  <li><a href="../source/set.lua.html">set.lua</a></li>
  <li><a href="../source/sip.lua.html">sip.lua</a></li>
  <li><a href="../source/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../source/strict.lua.html">strict.lua</a></li>
  <li><a href="../source/stringio.lua.html">stringio.lua</a></li>
  <li><a href="../source/stringx.lua.html">stringx.lua</a></li>
  <li><a href="../source/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../source/tablex.lua.html">tablex.lua</a></li>
  <li><a href="../source/template.lua.html">template.lua</a></li>
  <li><a href="../source/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../source/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../source/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../source/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../source/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../source/test.lua.html">test.lua</a></li>
  <li><a href="../source/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../source/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../source/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../source/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../source/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../source/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../source/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../source/text.lua.html">text.lua</a></li>
  <li><a href="../source/types.lua.html">types.lua</a></li>
  <li><a href="../source/url.lua.html">url.lua</a></li>
  <li><a href="../source/utils.lua.html">utils.lua</a></li>
  <li><a href="../source/which.lua.html">which.lua</a></li>
  <li><a href="../source/xml.lua.html">xml.lua</a></li>
</ul>
<h2>Libraries</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../libraries/pl.html">pl</a></li>
  <li><a href="../libraries/pl.app.html">pl.app</a></li>
  <li><a href="../libraries/pl.array2d.html">pl.array2d</a></li>
  <li><a href="../libraries/pl.class.html">pl.class</a></li>
  <li><a href="../libraries/pl.compat.html">pl.compat</a></li>
  <li><a href="../libraries/pl.comprehension.html">pl.comprehension</a></li>
  <li><a href="../libraries/pl.config.html">pl.config</a></li>
  <li><a href="../libraries/pl.data.html">pl.data</a></li>
  <li><a href="../libraries/pl.dir.html">pl.dir</a></li>
  <li><a href="../libraries/pl.file.html">pl.file</a></li>
  <li><a href="../libraries/pl.func.html">pl.func</a></li>
  <li><a href="../libraries/pl.import_into.html">pl.import_into</a></li>
  <li><a href="../libraries/pl.input.html">pl.input</a></li>
  <li><a href="../libraries/pl.lapp.html">pl.lapp</a></li>
  <li><a href="../libraries/pl.lexer.html">pl.lexer</a></li>
  <li><a href="../libraries/pl.luabalanced.html">pl.luabalanced</a></li>
  <li><a href="../libraries/pl.operator.html">pl.operator</a></li>
  <li><a href="../libraries/pl.path.html">pl.path</a></li>
  <li><a href="../libraries/pl.permute.html">pl.permute</a></li>
  <li><a href="../libraries/pl.pretty.html">pl.pretty</a></li>
  <li><a href="../libraries/pl.seq.html">pl.seq</a></li>
  <li><a href="../libraries/pl.sip.html">pl.sip</a></li>
  <li><a href="../libraries/pl.strict.html">pl.strict</a></li>
  <li><a href="../libraries/pl.stringio.html">pl.stringio</a></li>
  <li><a href="../libraries/pl.stringx.html">pl.stringx</a></li>
  <li><a href="../libraries/pl.tablex.html">pl.tablex</a></li>
  <li><a href="../libraries/pl.template.html">pl.template</a></li>
  <li><a href="../libraries/pl.test.html">pl.test</a></li>
  <li><a href="../libraries/pl.text.html">pl.text</a></li>
  <li><a href="../libraries/pl.types.html">pl.types</a></li>
  <li><a href="../libraries/pl.url.html">pl.url</a></li>
  <li><a href="../libraries/pl.utils.html">pl.utils</a></li>
  <li><a href="../libraries/pl.xml.html">pl.xml</a></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/pl.Date.html">pl.Date</a></li>
  <li><a href="../classes/pl.List.html">pl.List</a></li>
  <li><a href="../classes/pl.Map.html">pl.Map</a></li>
  <li><a href="../classes/pl.MultiMap.html">pl.MultiMap</a></li>
  <li><a href="../classes/pl.OrderedMap.html">pl.OrderedMap</a></li>
  <li><a href="../classes/pl.Set.html">pl.Set</a></li>
</ul>
<h2>Manual</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../manual/01-introduction.md.html">Introduction</a></li>
  <li><a href="../manual/02-arrays.md.html">Tables and Arrays</a></li>
  <li><a href="../manual/03-strings.md.html">Strings. Higher-level operations on strings.</a></li>
  <li><a href="../manual/04-paths.md.html">Paths and Directories</a></li>
  <li><a href="../manual/05-dates.md.html">Date and Time</a></li>
  <li><a href="../manual/06-data.md.html">Data</a></li>
  <li><a href="../manual/07-functional.md.html">Functional Programming</a></li>
  <li><a href="../manual/08-additional.md.html">Additional Libraries</a></li>
  <li><a href="../manual/09-discussion.md.html">Technical Choices</a></li>
</ul>
<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../examples/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../examples/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../examples/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../examples/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../examples/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../examples/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../examples/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../examples/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../examples/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../examples/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../examples/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../examples/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../examples/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../examples/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../examples/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../examples/which.lua.html">which.lua</a></li>
</ul>

</div>

<div id="content">

    <h2>array2d.lua</h2>
<pre>
<span class="comment">--- Operations on two-dimensional arrays.
</span><span class="comment">-- See <a href="../manual/02-arrays.md.html#Operations_on_two_dimensional_tables">The Guide</a>
</span><span class="comment">--
</span><span class="comment">-- Dependencies: <a href="../libraries/pl.utils.html#">pl.utils</a>, <a href="../libraries/pl.tablex.html#">pl.tablex</a>, <a href="../libraries/pl.types.html#">pl.types</a>
</span><span class="comment">-- @module pl.array2d
</span>
<span class="keyword">local</span> <span class="global">type</span>,<span class="global">tonumber</span>,<span class="global">assert</span>,<span class="global">tostring</span>,<span class="global">io</span>,<span class="global">ipairs</span>,<span class="global">string</span>,<span class="global">table</span> =
    _G.<span class="global">type</span>,_G.<span class="global">tonumber</span>,_G.<span class="global">assert</span>,_G.<span class="global">tostring</span>,_G.<span class="global">io</span>,_G.<span class="global">ipairs</span>,_G.<span class="global">string</span>,_G.<span class="global">table</span>
<span class="keyword">local</span> <span class="global">setmetatable</span>,<span class="global">getmetatable</span> = <span class="global">setmetatable</span>,<span class="global">getmetatable</span>

<span class="keyword">local</span> tablex = <span class="global">require</span> <span class="string">'pl.tablex'</span>
<span class="keyword">local</span> utils = <span class="global">require</span> <span class="string">'pl.utils'</span>
<span class="keyword">local</span> types = <span class="global">require</span> <span class="string">'pl.types'</span>
<span class="keyword">local</span> imap,tmap,reduce,keys,tmap2,tset,index_by = tablex.imap,tablex.map,tablex.reduce,tablex.keys,tablex.map2,tablex.set,tablex.index_by
<span class="keyword">local</span> remove = <span class="global">table</span>.remove
<span class="keyword">local</span> splitv,fprintf,assert_arg = utils.splitv,utils.fprintf,utils.assert_arg
<span class="keyword">local</span> byte = <span class="global">string</span>.byte
<span class="keyword">local</span> stdout = <span class="global">io</span>.stdout

<span class="keyword">local</span> array2d = {}

<span class="keyword">local</span> <span class="keyword">function</span> obj (int,out)
    <span class="keyword">local</span> mt = <span class="global">getmetatable</span>(int)
    <span class="keyword">if</span> mt <span class="keyword">then</span>
        <span class="global">setmetatable</span>(out,mt)
    <span class="keyword">end</span>
    <span class="keyword">return</span> out
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> makelist (res)
    <span class="keyword">return</span> <span class="global">setmetatable</span>(res,utils.stdmt.List)
<span class="keyword">end</span>


<span class="keyword">local</span> <span class="keyword">function</span> index (t,k)
    <span class="keyword">return</span> t[k]
<span class="keyword">end</span>

<span class="comment">--- return the row and column size.
</span><span class="comment">-- @array2d t a 2d array
</span><span class="comment">-- @treturn int number of rows
</span><a id="43"></a><span class="comment">-- @treturn int number of cols
</span><span class="keyword">function</span> array2d.size (t)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    <span class="keyword">return</span> #t,#t[<span class="number">1</span>]
<span class="keyword">end</span>

<span class="comment">--- extract a column from the 2D array.
</span><span class="comment">-- @array2d a 2d array
</span><span class="comment">-- @param key an index or key
</span><a id="52"></a><span class="comment">-- @return 1d array
</span><span class="keyword">function</span> array2d.column (a,key)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    <span class="keyword">return</span> makelist(imap(index,a,key))
<span class="keyword">end</span>
<span class="keyword">local</span> column = array2d.column

<span class="comment">--- map a function over a 2D array
</span><span class="comment">-- @func f a function of at least one argument
</span><span class="comment">-- @array2d a 2d array
</span><span class="comment">-- @param arg an optional extra argument to be passed to the function.
</span><a id="63"></a><span class="comment">-- @return 2d array
</span><span class="keyword">function</span> array2d.map (f,a,arg)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    f = utils.function_arg(<span class="number">1</span>,f)
    <span class="keyword">return</span> obj(a,imap(<span class="keyword">function</span>(row) <span class="keyword">return</span> imap(f,row,arg) <span class="keyword">end</span>, a))
<span class="keyword">end</span>

<span class="comment">--- reduce the rows using a function.
</span><span class="comment">-- @func f a binary function
</span><span class="comment">-- @array2d a 2d array
</span><span class="comment">-- @return 1d array
</span><a id="74"></a><span class="comment">-- @see pl.tablex.reduce
</span><span class="keyword">function</span> array2d.reduce_rows (f,a)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    <span class="keyword">return</span> tmap(<span class="keyword">function</span>(row) <span class="keyword">return</span> reduce(f,row) <span class="keyword">end</span>, a)
<span class="keyword">end</span>

<span class="comment">--- reduce the columns using a function.
</span><span class="comment">-- @func f a binary function
</span><span class="comment">-- @array2d a 2d array
</span><span class="comment">-- @return 1d array
</span><a id="84"></a><span class="comment">-- @see pl.tablex.reduce
</span><span class="keyword">function</span> array2d.reduce_cols (f,a)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    <span class="keyword">return</span> tmap(<span class="keyword">function</span>(c) <span class="keyword">return</span> reduce(f,column(a,c)) <span class="keyword">end</span>, keys(a[<span class="number">1</span>]))
<span class="keyword">end</span>

<span class="comment">--- reduce a 2D array into a scalar, using two operations.
</span><span class="comment">-- @func opc operation to reduce the final result
</span><span class="comment">-- @func opr operation to reduce the rows
</span><a id="93"></a><span class="comment">-- @param a 2D array
</span><span class="keyword">function</span> array2d.reduce2 (opc,opr,a)
    assert_arg(<span class="number">3</span>,a,<span class="string">'table'</span>)
    <span class="keyword">local</span> tmp = array2d.reduce_rows(opr,a)
    <span class="keyword">return</span> reduce(opc,tmp)
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> dimension (t)
    <span class="keyword">return</span> <span class="global">type</span>(t[<span class="number">1</span>])==<span class="string">'table'</span> <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">or</span> <span class="number">1</span>
<span class="keyword">end</span>

<span class="comment">--- map a function over two arrays.
</span><span class="comment">-- They can be both or either 2D arrays
</span><span class="comment">-- @func f function of at least two arguments
</span><span class="comment">-- @int ad order of first array (1 or 2)
</span><span class="comment">-- @int bd order of second array (1 or 2)
</span><span class="comment">-- @tab a 1d or 2d array
</span><span class="comment">-- @tab b 1d or 2d array
</span><span class="comment">-- @param arg optional extra argument to pass to function
</span><a id="112"></a><span class="comment">-- @return 2D array, unless both arrays are 1D
</span><span class="keyword">function</span> array2d.map2 (f,ad,bd,a,b,arg)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    assert_arg(<span class="number">2</span>,b,<span class="string">'table'</span>)
    f = utils.function_arg(<span class="number">1</span>,f)
    <span class="keyword">if</span> ad == <span class="number">1</span> <span class="keyword">and</span> bd == <span class="number">2</span> <span class="keyword">then</span>
        <span class="keyword">return</span> imap(<span class="keyword">function</span>(row)
            <span class="keyword">return</span> tmap2(f,a,row,arg)
        <span class="keyword">end</span>, b)
    <span class="keyword">elseif</span> ad == <span class="number">2</span> <span class="keyword">and</span> bd == <span class="number">1</span> <span class="keyword">then</span>
        <span class="keyword">return</span> imap(<span class="keyword">function</span>(row)
            <span class="keyword">return</span> tmap2(f,row,b,arg)
        <span class="keyword">end</span>, a)
    <span class="keyword">elseif</span> ad == <span class="number">1</span> <span class="keyword">and</span> bd == <span class="number">1</span> <span class="keyword">then</span>
        <span class="keyword">return</span> tmap2(f,a,b)
    <span class="keyword">elseif</span> ad == <span class="number">2</span> <span class="keyword">and</span> bd == <span class="number">2</span> <span class="keyword">then</span>
        <span class="keyword">return</span> tmap2(<span class="keyword">function</span>(rowa,rowb)
            <span class="keyword">return</span> tmap2(f,rowa,rowb,arg)
        <span class="keyword">end</span>, a,b)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- cartesian product of two 1d arrays.
</span><span class="comment">-- @func f a function of 2 arguments
</span><span class="comment">-- @array t1 a 1d table
</span><span class="comment">-- @array t2 a 1d table
</span><span class="comment">-- @return 2d table
</span><a id="139"></a><span class="comment">-- @usage product('..',{1,2},{'a','b'}) == {{'1a','2a'},{'1b','2b'}}
</span><span class="keyword">function</span> array2d.product (f,t1,t2)
    f = utils.function_arg(<span class="number">1</span>,f)
    assert_arg(<span class="number">2</span>,t1,<span class="string">'table'</span>)
    assert_arg(<span class="number">3</span>,t2,<span class="string">'table'</span>)
    <span class="keyword">local</span> res, map = {}, tablex.map
    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="global">ipairs</span>(t2) <span class="keyword">do</span>
        res[i] = map(f,t1,v)
    <span class="keyword">end</span>
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="comment">--- flatten a 2D array.
</span><span class="comment">-- (this goes over columns first.)
</span><span class="comment">-- @array2d t 2d table
</span><span class="comment">-- @return a 1d table
</span><a id="155"></a><span class="comment">-- @usage flatten {{1,2},{3,4},{5,6}} == {1,2,3,4,5,6}
</span><span class="keyword">function</span> array2d.flatten (t)
    <span class="keyword">local</span> res = {}
    <span class="keyword">local</span> k = <span class="number">1</span>
    <span class="keyword">for</span> _,a <span class="keyword">in</span> <span class="global">ipairs</span>(t) <span class="keyword">do</span> <span class="comment">-- for all rows
</span>        <span class="keyword">for</span> i = <span class="number">1</span>,#a <span class="keyword">do</span>
            res[k] = a[i]
            k = k + <span class="number">1</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> makelist(res)
<span class="keyword">end</span>

<span class="comment">--- reshape a 2D array.
</span><span class="comment">-- @array2d t 2d array
</span><span class="comment">-- @int nrows new number of rows
</span><span class="comment">-- @bool co column-order (Fortran-style) (default false)
</span><a id="172"></a><span class="comment">-- @return a new 2d array
</span><span class="keyword">function</span> array2d.reshape (t,nrows,co)
    <span class="keyword">local</span> nr,nc = array2d.size(t)
    <span class="keyword">local</span> ncols = nr*nc / nrows
    <span class="keyword">local</span> res = {}
    <span class="keyword">local</span> ir,ic = <span class="number">1</span>,<span class="number">1</span>
    <span class="keyword">for</span> i = <span class="number">1</span>,nrows <span class="keyword">do</span>
        <span class="keyword">local</span> row = {}
        <span class="keyword">for</span> j = <span class="number">1</span>,ncols <span class="keyword">do</span>
            row[j] = t[ir][ic]
            <span class="keyword">if</span> <span class="keyword">not</span> co <span class="keyword">then</span>
                ic = ic + <span class="number">1</span>
                <span class="keyword">if</span> ic &gt; nc <span class="keyword">then</span>
                    ir = ir + <span class="number">1</span>
                    ic = <span class="number">1</span>
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                ir = ir + <span class="number">1</span>
                <span class="keyword">if</span> ir &gt; nr <span class="keyword">then</span>
                    ic = ic + <span class="number">1</span>
                    ir = <span class="number">1</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        res[i] = row
    <span class="keyword">end</span>
    <span class="keyword">return</span> obj(t,res)
<span class="keyword">end</span>

<span class="comment">--- swap two rows of an array.
</span><span class="comment">-- @array2d t a 2d array
</span><span class="comment">-- @int i1 a row index
</span><a id="204"></a><span class="comment">-- @int i2 a row index
</span><span class="keyword">function</span> array2d.swap_rows (t,i1,i2)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    t[i1],t[i2] = t[i2],t[i1]
<span class="keyword">end</span>

<span class="comment">--- swap two columns of an array.
</span><span class="comment">-- @array2d t a 2d array
</span><span class="comment">-- @int j1 a column index
</span><a id="213"></a><span class="comment">-- @int j2 a column index
</span><span class="keyword">function</span> array2d.swap_cols (t,j1,j2)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    <span class="keyword">for</span> i = <span class="number">1</span>,#t <span class="keyword">do</span>
        <span class="keyword">local</span> row = t[i]
        row[j1],row[j2] = row[j2],row[j1]
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- extract the specified rows.
</span><span class="comment">-- @array2d t 2d array
</span><a id="224"></a><span class="comment">-- @tparam {int} ridx a table of row indices
</span><span class="keyword">function</span> array2d.extract_rows (t,ridx)
    <span class="keyword">return</span> obj(t,index_by(t,ridx))
<span class="keyword">end</span>

<span class="comment">--- extract the specified columns.
</span><span class="comment">-- @array2d t 2d array
</span><a id="231"></a><span class="comment">-- @tparam {int} cidx a table of column indices
</span><span class="keyword">function</span> array2d.extract_cols (t,cidx)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    <span class="keyword">local</span> res = {}
    <span class="keyword">for</span> i = <span class="number">1</span>,#t <span class="keyword">do</span>
        res[i] = index_by(t[i],cidx)
    <span class="keyword">end</span>
    <span class="keyword">return</span> obj(t,res)
<span class="keyword">end</span>

<span class="comment">--- remove a row from an array.
</span><span class="comment">-- @function array2d.remove_row
</span><span class="comment">-- @array2d t a 2d array
</span><a id="244"></a><span class="comment">-- @int i a row index
</span>array2d.remove_row = remove

<span class="comment">--- remove a column from an array.
</span><span class="comment">-- @array2d t a 2d array
</span><a id="249"></a><span class="comment">-- @int j a column index
</span><span class="keyword">function</span> array2d.remove_col (t,j)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    <span class="keyword">for</span> i = <span class="number">1</span>,#t <span class="keyword">do</span>
        remove(t[i],j)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> Ai = byte <span class="string">'A'</span>

<span class="keyword">local</span> <span class="keyword">function</span> _parse (s)
    <span class="keyword">local</span> c,r
    <span class="keyword">if</span> s:sub(<span class="number">1</span>,<span class="number">1</span>) == <span class="string">'R'</span> <span class="keyword">then</span>
        r,c = s:match <span class="string">'R(%d+)C(%d+)'</span>
        r,c = <span class="global">tonumber</span>(r),<span class="global">tonumber</span>(c)
    <span class="keyword">else</span>
        c,r = s:match <span class="string">'(.)(.)'</span>
        c = byte(c) - byte <span class="string">'A'</span> + <span class="number">1</span>
        r = <span class="global">tonumber</span>(r)
    <span class="keyword">end</span>
    <span class="global">assert</span>(c ~= <span class="keyword">nil</span> <span class="keyword">and</span> r ~= <span class="keyword">nil</span>,<span class="string">'bad cell specifier: '</span>..s)
    <span class="keyword">return</span> r,c
<span class="keyword">end</span>

<span class="comment">--- parse a spreadsheet range.
</span><span class="comment">-- The range can be specified either as 'A1:B2' or 'R1C1:R2C2';
</span><span class="comment">-- a special case is a single element (e.g 'A1' or 'R1C1')
</span><span class="comment">-- @string s a range.
</span><span class="comment">-- @treturn int start col
</span><span class="comment">-- @treturn int start row
</span><span class="comment">-- @treturn int end col
</span><a id="280"></a><span class="comment">-- @treturn int end row
</span><span class="keyword">function</span> array2d.parse_range (s)
    <span class="keyword">if</span> s:find <span class="string">':'</span> <span class="keyword">then</span>
        <span class="keyword">local</span> start,finish = splitv(s,<span class="string">':'</span>)
        <span class="keyword">local</span> i1,j1 = _parse(start)
        <span class="keyword">local</span> i2,j2 = _parse(finish)
        <span class="keyword">return</span> i1,j1,i2,j2
    <span class="keyword">else</span> <span class="comment">-- single value
</span>        <span class="keyword">local</span> i,j = _parse(s)
        <span class="keyword">return</span> i,j
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- get a slice of a 2D array using spreadsheet range notation. @see parse_range
</span><span class="comment">-- @array2d t a 2D array
</span><span class="comment">-- @string rstr range expression
</span><span class="comment">-- @return a slice
</span><span class="comment">-- @see array2d.parse_range
</span><a id="298"></a><span class="comment">-- @see array2d.slice
</span><span class="keyword">function</span> array2d.range (t,rstr)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    <span class="keyword">local</span> i1,j1,i2,j2 = array2d.parse_range(rstr)
    <span class="keyword">if</span> i2 <span class="keyword">then</span>
        <span class="keyword">return</span> array2d.slice(t,i1,j1,i2,j2)
    <span class="keyword">else</span> <span class="comment">-- single value
</span>        <span class="keyword">return</span> t[i1][j1]
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> default_range (t,i1,j1,i2,j2)
    <span class="keyword">local</span> nr, nc = array2d.size(t)
    i1,j1 = i1 <span class="keyword">or</span> <span class="number">1</span>, j1 <span class="keyword">or</span> <span class="number">1</span>
    i2,j2 = i2 <span class="keyword">or</span> nr, j2 <span class="keyword">or</span> nc
    <span class="keyword">if</span> i2 &lt; <span class="number">0</span> <span class="keyword">then</span> i2 = nr + i2 + <span class="number">1</span> <span class="keyword">end</span>
    <span class="keyword">if</span> j2 &lt; <span class="number">0</span> <span class="keyword">then</span> j2 = nc + j2 + <span class="number">1</span> <span class="keyword">end</span>
    <span class="keyword">return</span> i1,j1,i2,j2
<span class="keyword">end</span>

<span class="comment">--- get a slice of a 2D array. Note that if the specified range has
</span><span class="comment">-- a 1D result, the rank of the result will be 1.
</span><span class="comment">-- @array2d t a 2D array
</span><span class="comment">-- @int i1 start row (default 1)
</span><span class="comment">-- @int j1 start col (default 1)
</span><span class="comment">-- @int i2 end row   (default N)
</span><span class="comment">-- @int j2 end col   (default M)
</span><a id="325"></a><span class="comment">-- @return an array, 2D in general but 1D in special cases.
</span><span class="keyword">function</span> array2d.slice (t,i1,j1,i2,j2)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    i1,j1,i2,j2 = default_range(t,i1,j1,i2,j2)
    <span class="keyword">local</span> res = {}
    <span class="keyword">for</span> i = i1,i2 <span class="keyword">do</span>
        <span class="keyword">local</span> val
        <span class="keyword">local</span> row = t[i]
        <span class="keyword">if</span> j1 == j2 <span class="keyword">then</span>
            val = row[j1]
        <span class="keyword">else</span>
            val = {}
            <span class="keyword">for</span> j = j1,j2 <span class="keyword">do</span>
                val[#val+<span class="number">1</span>] = row[j]
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        res[#res+<span class="number">1</span>] = val
    <span class="keyword">end</span>
    <span class="keyword">if</span> i1 == i2 <span class="keyword">then</span> res = res[<span class="number">1</span>] <span class="keyword">end</span>
    <span class="keyword">return</span> obj(t,res)
<span class="keyword">end</span>

<span class="comment">--- set a specified range of an array to a value.
</span><span class="comment">-- @array2d t a 2D array
</span><span class="comment">-- @param value the value (may be a function)
</span><span class="comment">-- @int i1 start row (default 1)
</span><span class="comment">-- @int j1 start col (default 1)
</span><span class="comment">-- @int i2 end row   (default N)
</span><span class="comment">-- @int j2 end col   (default M)
</span><a id="354"></a><span class="comment">-- @see tablex.set
</span><span class="keyword">function</span> array2d.set (t,value,i1,j1,i2,j2)
    i1,j1,i2,j2 = default_range(t,i1,j1,i2,j2)
    <span class="keyword">for</span> i = i1,i2 <span class="keyword">do</span>
        tset(t[i],value,j1,j2)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- write a 2D array to a file.
</span><span class="comment">-- @array2d t a 2D array
</span><span class="comment">-- @param f a file object (default stdout)
</span><span class="comment">-- @string fmt a format string (default is just to use tostring)
</span><span class="comment">-- @int i1 start row (default 1)
</span><span class="comment">-- @int j1 start col (default 1)
</span><span class="comment">-- @int i2 end row   (default N)
</span><a id="369"></a><span class="comment">-- @int j2 end col   (default M)
</span><span class="keyword">function</span> array2d.write (t,f,fmt,i1,j1,i2,j2)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    f = f <span class="keyword">or</span> stdout
    <span class="keyword">local</span> rowop
    <span class="keyword">if</span> fmt <span class="keyword">then</span>
        rowop = <span class="keyword">function</span>(row,j) fprintf(f,fmt,row[j]) <span class="keyword">end</span>
    <span class="keyword">else</span>
        rowop = <span class="keyword">function</span>(row,j) f:write(<span class="global">tostring</span>(row[j]),<span class="string">' '</span>) <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">local</span> <span class="keyword">function</span> newline()
        f:write <span class="string">'\n'</span>
    <span class="keyword">end</span>
    array2d.forall(t,rowop,newline,i1,j1,i2,j2)
<span class="keyword">end</span>

<span class="comment">--- perform an operation for all values in a 2D array.
</span><span class="comment">-- @array2d t 2D array
</span><span class="comment">-- @func row_op function to call on each value
</span><span class="comment">-- @func end_row_op function to call at end of each row
</span><span class="comment">-- @int i1 start row (default 1)
</span><span class="comment">-- @int j1 start col (default 1)
</span><span class="comment">-- @int i2 end row   (default N)
</span><a id="392"></a><span class="comment">-- @int j2 end col   (default M)
</span><span class="keyword">function</span> array2d.forall (t,row_op,end_row_op,i1,j1,i2,j2)
    assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
    i1,j1,i2,j2 = default_range(t,i1,j1,i2,j2)
    <span class="keyword">for</span> i = i1,i2 <span class="keyword">do</span>
        <span class="keyword">local</span> row = t[i]
        <span class="keyword">for</span> j = j1,j2 <span class="keyword">do</span>
            row_op(row,j)
        <span class="keyword">end</span>
        <span class="keyword">if</span> end_row_op <span class="keyword">then</span> end_row_op(i) <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> min, max = <span class="global">math</span>.min, <span class="global">math</span>.max

<span class="comment">---- move a block from the destination to the source.
</span><span class="comment">-- @array2d dest a 2D array
</span><span class="comment">-- @int di start row in dest
</span><span class="comment">-- @int dj start col in dest
</span><span class="comment">-- @array2d src a 2D array
</span><span class="comment">-- @int i1 start row (default 1)
</span><span class="comment">-- @int j1 start col (default 1)
</span><span class="comment">-- @int i2 end row   (default N)
</span><a id="415"></a><span class="comment">-- @int j2 end col   (default M)
</span><span class="keyword">function</span> array2d.move (dest,di,dj,src,i1,j1,i2,j2)
    assert_arg(<span class="number">1</span>,dest,<span class="string">'table'</span>)
    assert_arg(<span class="number">4</span>,src,<span class="string">'table'</span>)
    i1,j1,i2,j2 = default_range(src,i1,j1,i2,j2)
    <span class="keyword">local</span> nr,nc = array2d.size(dest)
    i2, j2 = min(nr,i2), min(nc,j2)
    <span class="comment">--i1, j1 = max(1,i1), max(1,j1)
</span>    dj = dj - <span class="number">1</span>
    <span class="keyword">for</span> i = i1,i2 <span class="keyword">do</span>
        <span class="keyword">local</span> drow, srow = dest[i+di-<span class="number">1</span>], src[i]
        <span class="keyword">for</span> j = j1,j2 <span class="keyword">do</span>
            drow[j+dj] = srow[j]
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- iterate over all elements in a 2D array, with optional indices.
</span><span class="comment">-- @array2d a 2D array
</span><span class="comment">-- @tparam {int} indices with indices (default false)
</span><span class="comment">-- @int i1 start row (default 1)
</span><span class="comment">-- @int j1 start col (default 1)
</span><span class="comment">-- @int i2 end row   (default N)
</span><span class="comment">-- @int j2 end col   (default M)
</span><a id="439"></a><span class="comment">-- @return either value or i,j,value depending on indices
</span><span class="keyword">function</span> array2d.iter (a,indices,i1,j1,i2,j2)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    <span class="keyword">local</span> norowset = <span class="keyword">not</span> (i2 <span class="keyword">and</span> j2)
    i1,j1,i2,j2 = default_range(a,i1,j1,i2,j2)
    <span class="keyword">local</span> n,i,j = i2-i1+<span class="number">1</span>,i1-<span class="number">1</span>,j1-<span class="number">1</span>
    <span class="keyword">local</span> row,nr = <span class="keyword">nil</span>,<span class="number">0</span>
    <span class="keyword">local</span> onr = j2 - j1 + <span class="number">1</span>
    <span class="keyword">return</span> <span class="keyword">function</span>()
        j = j + <span class="number">1</span>
        <span class="keyword">if</span> j &gt; nr <span class="keyword">then</span>
            j = j1
            i = i + <span class="number">1</span>
            <span class="keyword">if</span> i &gt; i2 <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
            row = a[i]
            nr = norowset <span class="keyword">and</span> #row <span class="keyword">or</span> onr
        <span class="keyword">end</span>
        <span class="keyword">if</span> indices <span class="keyword">then</span>
            <span class="keyword">return</span> i,j,row[j]
        <span class="keyword">else</span>
            <span class="keyword">return</span> row[j]
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- iterate over all columns.
</span><span class="comment">-- @array2d a a 2D array
</span><a id="466"></a><span class="comment">-- @return each column in turn
</span><span class="keyword">function</span> array2d.columns (a)
    assert_arg(<span class="number">1</span>,a,<span class="string">'table'</span>)
    <span class="keyword">local</span> n = a[<span class="number">1</span>][<span class="number">1</span>]
    <span class="keyword">local</span> i = <span class="number">0</span>
    <span class="keyword">return</span> <span class="keyword">function</span>()
        i = i + <span class="number">1</span>
        <span class="keyword">if</span> i &gt; n <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
        <span class="keyword">return</span> column(a,i)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- new array of specified dimensions
</span><span class="comment">-- @int rows number of rows
</span><span class="comment">-- @int cols number of cols
</span><span class="comment">-- @param val initial value; if it's a function then use <code>val(i,j)</code>
</span><a id="482"></a><span class="comment">-- @return new 2d array
</span><span class="keyword">function</span> array2d.new(rows,cols,val)
    <span class="keyword">local</span> res = {}
    <span class="keyword">local</span> fun = types.is_callable(val)
    <span class="keyword">for</span> i = <span class="number">1</span>,rows <span class="keyword">do</span>
        <span class="keyword">local</span> row = {}
        <span class="keyword">if</span> fun <span class="keyword">then</span>
            <span class="keyword">for</span> j = <span class="number">1</span>,cols <span class="keyword">do</span> row[j] = val(i,j) <span class="keyword">end</span>
        <span class="keyword">else</span>
            <span class="keyword">for</span> j = <span class="number">1</span>,cols <span class="keyword">do</span> row[j] = val <span class="keyword">end</span>
        <span class="keyword">end</span>
        res[i] = row
    <span class="keyword">end</span>
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="keyword">return</span> array2d</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2014-11-01 18:36:39 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
