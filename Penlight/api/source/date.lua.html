<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Penlight Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Penlight</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../source/app.lua.html">app.lua</a></li>
  <li><a href="../source/array2d.lua.html">array2d.lua</a></li>
  <li><a href="../source/class.lua.html">class.lua</a></li>
  <li><a href="../source/compat.lua.html">compat.lua</a></li>
  <li><a href="../source/comprehension.lua.html">comprehension.lua</a></li>
  <li><a href="../source/config.lua.html">config.lua</a></li>
  <li><a href="../source/data.lua.html">data.lua</a></li>
  <li><strong>date.lua</strong></li>
  <li><a href="../source/dir.lua.html">dir.lua</a></li>
  <li><a href="../source/file.lua.html">file.lua</a></li>
  <li><a href="../source/func.lua.html">func.lua</a></li>
  <li><a href="../source/import_into.lua.html">import_into.lua</a></li>
  <li><a href="../source/init.lua.html">init.lua</a></li>
  <li><a href="../source/input.lua.html">input.lua</a></li>
  <li><a href="../source/lapp.lua.html">lapp.lua</a></li>
  <li><a href="../source/lexer.lua.html">lexer.lua</a></li>
  <li><a href="../source/list.lua.html">list.lua</a></li>
  <li><a href="../source/luabalanced.lua.html">luabalanced.lua</a></li>
  <li><a href="../source/map.lua.html">map.lua</a></li>
  <li><a href="../source/multimap.lua.html">multimap.lua</a></li>
  <li><a href="../source/operator.lua.html">operator.lua</a></li>
  <li><a href="../source/orderedmap.lua.html">orderedmap.lua</a></li>
  <li><a href="../source/path.lua.html">path.lua</a></li>
  <li><a href="../source/permute.lua.html">permute.lua</a></li>
  <li><a href="../source/pretty.lua.html">pretty.lua</a></li>
  <li><a href="../source/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../source/seq.lua.html">seq.lua</a></li>
  <li><a href="../source/set.lua.html">set.lua</a></li>
  <li><a href="../source/sip.lua.html">sip.lua</a></li>
  <li><a href="../source/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../source/strict.lua.html">strict.lua</a></li>
  <li><a href="../source/stringio.lua.html">stringio.lua</a></li>
  <li><a href="../source/stringx.lua.html">stringx.lua</a></li>
  <li><a href="../source/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../source/tablex.lua.html">tablex.lua</a></li>
  <li><a href="../source/template.lua.html">template.lua</a></li>
  <li><a href="../source/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../source/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../source/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../source/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../source/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../source/test.lua.html">test.lua</a></li>
  <li><a href="../source/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../source/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../source/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../source/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../source/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../source/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../source/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../source/text.lua.html">text.lua</a></li>
  <li><a href="../source/types.lua.html">types.lua</a></li>
  <li><a href="../source/url.lua.html">url.lua</a></li>
  <li><a href="../source/utils.lua.html">utils.lua</a></li>
  <li><a href="../source/which.lua.html">which.lua</a></li>
  <li><a href="../source/xml.lua.html">xml.lua</a></li>
</ul>
<h2>Libraries</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../libraries/pl.html">pl</a></li>
  <li><a href="../libraries/pl.app.html">pl.app</a></li>
  <li><a href="../libraries/pl.array2d.html">pl.array2d</a></li>
  <li><a href="../libraries/pl.class.html">pl.class</a></li>
  <li><a href="../libraries/pl.compat.html">pl.compat</a></li>
  <li><a href="../libraries/pl.comprehension.html">pl.comprehension</a></li>
  <li><a href="../libraries/pl.config.html">pl.config</a></li>
  <li><a href="../libraries/pl.data.html">pl.data</a></li>
  <li><a href="../libraries/pl.dir.html">pl.dir</a></li>
  <li><a href="../libraries/pl.file.html">pl.file</a></li>
  <li><a href="../libraries/pl.func.html">pl.func</a></li>
  <li><a href="../libraries/pl.import_into.html">pl.import_into</a></li>
  <li><a href="../libraries/pl.input.html">pl.input</a></li>
  <li><a href="../libraries/pl.lapp.html">pl.lapp</a></li>
  <li><a href="../libraries/pl.lexer.html">pl.lexer</a></li>
  <li><a href="../libraries/pl.luabalanced.html">pl.luabalanced</a></li>
  <li><a href="../libraries/pl.operator.html">pl.operator</a></li>
  <li><a href="../libraries/pl.path.html">pl.path</a></li>
  <li><a href="../libraries/pl.permute.html">pl.permute</a></li>
  <li><a href="../libraries/pl.pretty.html">pl.pretty</a></li>
  <li><a href="../libraries/pl.seq.html">pl.seq</a></li>
  <li><a href="../libraries/pl.sip.html">pl.sip</a></li>
  <li><a href="../libraries/pl.strict.html">pl.strict</a></li>
  <li><a href="../libraries/pl.stringio.html">pl.stringio</a></li>
  <li><a href="../libraries/pl.stringx.html">pl.stringx</a></li>
  <li><a href="../libraries/pl.tablex.html">pl.tablex</a></li>
  <li><a href="../libraries/pl.template.html">pl.template</a></li>
  <li><a href="../libraries/pl.test.html">pl.test</a></li>
  <li><a href="../libraries/pl.text.html">pl.text</a></li>
  <li><a href="../libraries/pl.types.html">pl.types</a></li>
  <li><a href="../libraries/pl.url.html">pl.url</a></li>
  <li><a href="../libraries/pl.utils.html">pl.utils</a></li>
  <li><a href="../libraries/pl.xml.html">pl.xml</a></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/pl.Date.html">pl.Date</a></li>
  <li><a href="../classes/pl.List.html">pl.List</a></li>
  <li><a href="../classes/pl.Map.html">pl.Map</a></li>
  <li><a href="../classes/pl.MultiMap.html">pl.MultiMap</a></li>
  <li><a href="../classes/pl.OrderedMap.html">pl.OrderedMap</a></li>
  <li><a href="../classes/pl.Set.html">pl.Set</a></li>
</ul>
<h2>Manual</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../manual/01-introduction.md.html">Introduction</a></li>
  <li><a href="../manual/02-arrays.md.html">Tables and Arrays</a></li>
  <li><a href="../manual/03-strings.md.html">Strings. Higher-level operations on strings.</a></li>
  <li><a href="../manual/04-paths.md.html">Paths and Directories</a></li>
  <li><a href="../manual/05-dates.md.html">Date and Time</a></li>
  <li><a href="../manual/06-data.md.html">Data</a></li>
  <li><a href="../manual/07-functional.md.html">Functional Programming</a></li>
  <li><a href="../manual/08-additional.md.html">Additional Libraries</a></li>
  <li><a href="../manual/09-discussion.md.html">Technical Choices</a></li>
</ul>
<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../examples/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../examples/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../examples/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../examples/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../examples/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../examples/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../examples/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../examples/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../examples/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../examples/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../examples/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../examples/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../examples/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../examples/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../examples/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../examples/which.lua.html">which.lua</a></li>
</ul>

</div>

<div id="content">

    <h2>date.lua</h2>
<pre>
<span class="comment">--- Date and Date Format classes.
</span><span class="comment">-- See  <a href="../manual/05-dates.md.html#">the Guide</a>.
</span><span class="comment">--
</span><span class="comment">-- Dependencies: <a href="../libraries/pl.class.html#">pl.class</a>, <a href="../libraries/pl.stringx.html#">pl.stringx</a>
</span><span class="comment">-- @classmod pl.Date
</span><span class="comment">-- @pragma nostrip
</span>
<span class="keyword">local</span> class = <span class="global">require</span> <span class="string">'pl.class'</span>
<span class="keyword">local</span> os_time, os_date = <span class="global">os</span>.time, <span class="global">os</span>.date
<span class="keyword">local</span> stringx = <span class="global">require</span> <span class="string">'pl.stringx'</span>
<span class="keyword">local</span> utils = <span class="global">require</span> <span class="string">'pl.utils'</span>
<span class="keyword">local</span> assert_arg,assert_string,raise = utils.assert_arg,utils.assert_string,utils.raise

<span class="keyword">local</span> Date = class()
Date.Format = class()

<span class="comment">--- Date constructor.
</span><span class="comment">-- @param t this can be either
</span><span class="comment">--
</span><span class="comment">--   * <code>nil</code> or empty - use current date and time
</span><span class="comment">--   * number - seconds since epoch (as returned by <a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.time">os.time</a>). Resulting time is UTC
</span><span class="comment">--   * <a href="../classes/pl.Date.html#">Date</a> - make a copy of this date
</span><span class="comment">--   * table - table containing year, month, etc as for <a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.time">os.time</a>. You may leave out year, month or day,
</span><span class="comment">-- in which case current values will be used.
</span><span class="comment">--   * year (will be followed by month, day etc)
</span><span class="comment">--
</span><span class="comment">-- @param ...  true if  Universal Coordinated Time, or two to five numbers: month,day,hour,min,sec
</span><a id="29"></a><span class="comment">-- @function Date
</span><span class="keyword">function</span> Date:_init(t,...)
    <span class="keyword">local</span> time
    <span class="keyword">local</span> nargs = <span class="global">select</span>(<span class="string">'#'</span>,...)
    <span class="keyword">if</span> nargs &gt; <span class="number">2</span> <span class="keyword">then</span>
        <span class="keyword">local</span> extra = {...}
        <span class="keyword">local</span> year = t
        t = {
            year = year,
            month = extra[<span class="number">1</span>],
            day = extra[<span class="number">2</span>],
            hour = extra[<span class="number">3</span>],
            min = extra[<span class="number">4</span>],
            sec = extra[<span class="number">5</span>]
        }
    <span class="keyword">end</span>
    <span class="keyword">if</span> nargs == <span class="number">1</span> <span class="keyword">then</span>
        self.utc = <span class="global">select</span>(<span class="number">1</span>,...) == <span class="keyword">true</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> t == <span class="keyword">nil</span> <span class="keyword">or</span> t == <span class="string">'utc'</span> <span class="keyword">then</span>
        time = os_time()
        self.utc = t == <span class="string">'utc'</span>
    <span class="keyword">elseif</span> <span class="global">type</span>(t) == <span class="string">'number'</span> <span class="keyword">then</span>
        time = t
        <span class="keyword">if</span> self.utc == <span class="keyword">nil</span> <span class="keyword">then</span> self.utc = <span class="keyword">true</span> <span class="keyword">end</span>
    <span class="keyword">elseif</span> <span class="global">type</span>(t) == <span class="string">'table'</span> <span class="keyword">then</span>
        <span class="keyword">if</span> <span class="global">getmetatable</span>(t) == Date <span class="keyword">then</span> <span class="comment">-- copy ctor
</span>            time = t.time
            self.utc = t.utc
        <span class="keyword">else</span>
            <span class="keyword">if</span> <span class="keyword">not</span> (t.year <span class="keyword">and</span> t.month) <span class="keyword">then</span>
                <span class="keyword">local</span> lt = os_date(<span class="string">'*t'</span>)
                <span class="keyword">if</span> <span class="keyword">not</span> t.year <span class="keyword">and</span> <span class="keyword">not</span> t.month <span class="keyword">and</span> <span class="keyword">not</span> t.day <span class="keyword">then</span>
                    t.year = lt.year
                    t.month = lt.month
                    t.day = lt.day
                <span class="keyword">else</span>
                    t.year = t.year <span class="keyword">or</span> lt.year
                    t.month = t.month <span class="keyword">or</span> (t.day <span class="keyword">and</span> lt.month <span class="keyword">or</span> <span class="number">1</span>)
                    t.day = t.day <span class="keyword">or</span> <span class="number">1</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            t.day = t.day <span class="keyword">or</span> <span class="number">1</span>
            time = os_time(t)
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        error(<span class="string">"bad type for Date constructor: "</span>..<span class="global">type</span>(t),<span class="number">2</span>)
    <span class="keyword">end</span>
    self:set(time)
<span class="keyword">end</span>

<span class="comment">--- set the current time of this Date object.
</span><a id="81"></a><span class="comment">-- @int t seconds since epoch
</span><span class="keyword">function</span> Date:set(t)
    self.time = t
    <span class="keyword">if</span> self.utc <span class="keyword">then</span>
        self.tab = os_date(<span class="string">'!*t'</span>,t)
    <span class="keyword">else</span>
        self.tab = os_date(<span class="string">'*t'</span>,t)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- get the time zone offset from UTC.
</span><a id="92"></a><span class="comment">-- @int ts seconds ahead of UTC
</span><span class="keyword">function</span> Date.tzone (ts)
    <span class="keyword">if</span> ts == <span class="keyword">nil</span> <span class="keyword">then</span>
        ts = os_time()
    <span class="keyword">elseif</span> <span class="global">type</span>(ts) == <span class="string">"table"</span> <span class="keyword">then</span>
        <span class="keyword">if</span> <span class="global">getmetatable</span>(ts) == Date <span class="keyword">then</span>
        	ts = ts.time
        <span class="keyword">else</span>
        	ts = Date(ts).time
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">local</span> utc = os_date(<span class="string">'!*t'</span>,ts)
    <span class="keyword">local</span> lcl = os_date(<span class="string">'*t'</span>,ts)
    lcl.isdst = <span class="keyword">false</span>
    <span class="keyword">return</span> <span class="global">os</span>.difftime(os_time(lcl), os_time(utc))
<span class="keyword">end</span>

<a id="109"></a><span class="comment">--- convert this date to UTC.
</span><span class="keyword">function</span> Date:toUTC ()
    <span class="keyword">local</span> ndate = Date(self)
    <span class="keyword">if</span> <span class="keyword">not</span> self.utc <span class="keyword">then</span>
        ndate.utc = <span class="keyword">true</span>
        ndate:set(ndate.time)
    <span class="keyword">end</span>
    <span class="keyword">return</span> ndate
<span class="keyword">end</span>

<a id="119"></a><span class="comment">--- convert this UTC date to local.
</span><span class="keyword">function</span> Date:toLocal ()
    <span class="keyword">local</span> ndate = Date(self)
    <span class="keyword">if</span> self.utc <span class="keyword">then</span>
        ndate.utc = <span class="keyword">false</span>
        ndate:set(ndate.time)
<span class="comment">--~         ndate:add { sec = Date.tzone(self) }
</span>    <span class="keyword">end</span>
    <span class="keyword">return</span> ndate
<span class="keyword">end</span>

<span class="comment">--- set the year.
</span><span class="comment">-- @int y Four-digit year
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:year
</span><a id="134"></a>
<span class="comment">--- set the month.
</span><span class="comment">-- @int m month
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:month
</span><a id="139"></a>
<span class="comment">--- set the day.
</span><span class="comment">-- @int d day
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:day
</span><a id="144"></a>
<span class="comment">--- set the hour.
</span><span class="comment">-- @int h hour
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:hour
</span><a id="149"></a>
<span class="comment">--- set the minutes.
</span><span class="comment">-- @int min minutes
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:min
</span><a id="154"></a>
<span class="comment">--- set the seconds.
</span><span class="comment">-- @int sec seconds
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:sec
</span><a id="159"></a>
<span class="comment">--- set the day of year.
</span><span class="comment">-- @class function
</span><span class="comment">-- @int yday day of year
</span><span class="comment">-- @name Date:yday
</span><a id="164"></a>
<span class="comment">--- get the year.
</span><span class="comment">-- @int y Four-digit year
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:year
</span><a id="169"></a>
<span class="comment">--- get the month.
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:month
</span><a id="173"></a>
<span class="comment">--- get the day.
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:day
</span><a id="177"></a>
<span class="comment">--- get the hour.
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:hour
</span><a id="181"></a>
<span class="comment">--- get the minutes.
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:min
</span><a id="185"></a>
<span class="comment">--- get the seconds.
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:sec
</span><a id="189"></a>
<span class="comment">--- get the day of year.
</span><span class="comment">-- @class function
</span><span class="comment">-- @name Date:yday
</span><a id="194"></a>

<span class="keyword">for</span> _,c <span class="keyword">in</span> <span class="global">ipairs</span>{<span class="string">'year'</span>,<span class="string">'month'</span>,<span class="string">'day'</span>,<span class="string">'hour'</span>,<span class="string">'min'</span>,<span class="string">'sec'</span>,<span class="string">'yday'</span>} <span class="keyword">do</span>
    Date[c] = <span class="keyword">function</span>(self,val)
        <span class="keyword">if</span> val <span class="keyword">then</span>
            assert_arg(<span class="number">1</span>,val,<span class="string">"number"</span>)
            self.tab[c] = val
            self:set(os_time(self.tab))
            <span class="keyword">return</span> self
        <span class="keyword">else</span>
            <span class="keyword">return</span> self.tab[c]
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- name of day of week.
</span><span class="comment">-- @bool full abbreviated if true, full otherwise.
</span><a id="210"></a><span class="comment">-- @ret string name
</span><span class="keyword">function</span> Date:weekday_name(full)
    <span class="keyword">return</span> os_date(full <span class="keyword">and</span> <span class="string">'%A'</span> <span class="keyword">or</span> <span class="string">'%a'</span>,self.time)
<span class="keyword">end</span>

<span class="comment">--- name of month.
</span><span class="comment">-- @int full abbreviated if true, full otherwise.
</span><a id="217"></a><span class="comment">-- @ret string name
</span><span class="keyword">function</span> Date:month_name(full)
    <span class="keyword">return</span> os_date(full <span class="keyword">and</span> <span class="string">'%B'</span> <span class="keyword">or</span> <span class="string">'%b'</span>,self.time)
<span class="keyword">end</span>

<a id="222"></a><span class="comment">--- is this day on a weekend?.
</span><span class="keyword">function</span> Date:is_weekend()
    <span class="keyword">return</span> self.tab.wday == <span class="number">1</span> <span class="keyword">or</span> self.tab.wday == <span class="number">7</span>
<span class="keyword">end</span>

<span class="comment">--- add to a date object.
</span><span class="comment">-- @param t a table containing one of the following keys and a value:
</span><span class="comment">-- one of <code>year</code>,<code>month</code>,<code>day</code>,<code>hour</code>,<code>min</code>,<code>sec</code>
</span><a id="230"></a><span class="comment">-- @return this date
</span><span class="keyword">function</span> Date:add(t)
    <span class="keyword">local</span> old_dst = self.tab.isdst
    <span class="keyword">local</span> key,val = <span class="global">next</span>(t)
    self.tab[key] = self.tab[key] + val
    self:set(os_time(self.tab))
    <span class="keyword">if</span> old_dst ~= self.tab.isdst <span class="keyword">then</span>
        self.tab.hour = self.tab.hour - (old_dst <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> -<span class="number">1</span>)
        self:set(os_time(self.tab))
    <span class="keyword">end</span>
    <span class="keyword">return</span> self
<span class="keyword">end</span>

<span class="comment">--- last day of the month.
</span><a id="244"></a><span class="comment">-- @return int day
</span><span class="keyword">function</span> Date:last_day()
    <span class="keyword">local</span> d = <span class="number">28</span>
    <span class="keyword">local</span> m = self.tab.month
    <span class="keyword">while</span> self.tab.month == m <span class="keyword">do</span>
        d = d + <span class="number">1</span>
        self:add{day=<span class="number">1</span>}
    <span class="keyword">end</span>
    self:add{day=-<span class="number">1</span>}
    <span class="keyword">return</span> self
<span class="keyword">end</span>

<span class="comment">--- difference between two Date objects.
</span><span class="comment">-- @tparam Date other Date object
</span><a id="258"></a><span class="comment">-- @treturn Date.Interval object
</span><span class="keyword">function</span> Date:diff(other)
    <span class="keyword">local</span> dt = self.time - other.time
    <span class="keyword">if</span> dt &lt; <span class="number">0</span> <span class="keyword">then</span> error(<span class="string">"date difference is negative!"</span>,<span class="number">2</span>) <span class="keyword">end</span>
    <span class="keyword">return</span> Date.Interval(dt)
<span class="keyword">end</span>

<a id="265"></a><span class="comment">--- long numerical ISO data format version of this date.
</span><span class="keyword">function</span> Date:__tostring()
    <span class="keyword">local</span> t = os_date(<span class="string">'%Y-%m-%dT%H:%M:%S'</span>,self.time)
    <span class="keyword">if</span> self.utc <span class="keyword">then</span>
        <span class="keyword">return</span>  t .. <span class="string">'Z'</span>
    <span class="keyword">else</span>
        <span class="keyword">local</span> offs = self:tzone()
        <span class="keyword">if</span> offs == <span class="number">0</span> <span class="keyword">then</span>
            <span class="keyword">return</span> t .. <span class="string">'Z'</span>
        <span class="keyword">end</span>
        <span class="keyword">local</span> sign = offs &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="string">'+'</span> <span class="keyword">or</span> <span class="string">'-'</span>
        <span class="keyword">local</span> h = <span class="global">math</span>.ceil(offs/<span class="number">3600</span>)
        <span class="keyword">local</span> m = (offs % <span class="number">3600</span>)/<span class="number">60</span>
        <span class="keyword">if</span> m == <span class="number">0</span> <span class="keyword">then</span>
            <span class="keyword">return</span> t .. (<span class="string">'%s%02d'</span>):format(sign,h)
        <span class="keyword">else</span>
            <span class="keyword">return</span> t .. (<span class="string">'%s%02d:%02d'</span>):format(sign,h,m)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<a id="286"></a><span class="comment">--- equality between Date objects.
</span><span class="keyword">function</span> Date:__eq(other)
    <span class="keyword">return</span> self.time == other.time
<span class="keyword">end</span>

<a id="291"></a><span class="comment">--- ordering between Date objects.
</span><span class="keyword">function</span> Date:__lt(other)
    <span class="keyword">return</span> self.time &lt; other.time
<span class="keyword">end</span>

<span class="comment">--- difference between Date objects.
</span><a id="297"></a><span class="comment">-- @function Date:__sub
</span>Date.__sub = Date.diff

<span class="comment">--- add a date and an interval.
</span><span class="comment">-- @param other either a <a href="../classes/pl.Date.html#Date.Interval">Date.Interval</a> object or a table such as
</span><a id="302"></a><span class="comment">-- passed to <a href="../classes/pl.Date.html#Date:add">Date:add</a>
</span><span class="keyword">function</span> Date:__add(other)
    <span class="keyword">local</span> nd = Date(self)
    <span class="keyword">if</span> Date.Interval:class_of(other) <span class="keyword">then</span>
        other = {sec=other.time}
    <span class="keyword">end</span>
    nd:add(other)
    <span class="keyword">return</span> nd
<span class="keyword">end</span>

Date.Interval = class(Date)

<span class="comment">---- Date.Interval constructor
</span><span class="comment">-- @int t an interval in seconds
</span><a id="316"></a><span class="comment">-- @function Date.Interval
</span><span class="keyword">function</span> Date.Interval:_init(t)
    self:set(t)
<span class="keyword">end</span>

<span class="keyword">function</span> Date.Interval:set(t)
    self.time = t
    self.tab = os_date(<span class="string">'!*t'</span>,self.time)
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> ess(n)
    <span class="keyword">if</span> n &gt; <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'s '</span>
    <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">' '</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<a id="332"></a><span class="comment">--- If it's an interval then the format is '2 hours 29 sec' etc.
</span><span class="keyword">function</span> Date.Interval:__tostring()
    <span class="keyword">local</span> t, res = self.tab, <span class="string">''</span>
    <span class="keyword">local</span> y,m,d = t.year - <span class="number">1970</span>, t.month - <span class="number">1</span>, t.day - <span class="number">1</span>
    <span class="keyword">if</span> y &gt; <span class="number">0</span> <span class="keyword">then</span> res = res .. y .. <span class="string">' year'</span>..ess(y) <span class="keyword">end</span>
    <span class="keyword">if</span> m &gt; <span class="number">0</span> <span class="keyword">then</span> res = res .. m .. <span class="string">' month'</span>..ess(m) <span class="keyword">end</span>
    <span class="keyword">if</span> d &gt; <span class="number">0</span> <span class="keyword">then</span> res = res .. d .. <span class="string">' day'</span>..ess(d) <span class="keyword">end</span>
    <span class="keyword">if</span> y == <span class="number">0</span> <span class="keyword">and</span> m == <span class="number">0</span> <span class="keyword">then</span>
        <span class="keyword">local</span> h = t.hour
        <span class="keyword">if</span> h &gt; <span class="number">0</span> <span class="keyword">then</span> res = res .. h .. <span class="string">' hour'</span>..ess(h) <span class="keyword">end</span>
        <span class="keyword">if</span> t.min &gt; <span class="number">0</span> <span class="keyword">then</span> res = res .. t.min .. <span class="string">' min '</span> <span class="keyword">end</span>
        <span class="keyword">if</span> t.sec &gt; <span class="number">0</span> <span class="keyword">then</span> res = res .. t.sec .. <span class="string">' sec '</span> <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> res == <span class="string">''</span> <span class="keyword">then</span> res = <span class="string">'zero'</span> <span class="keyword">end</span>
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="comment">------------ Date.Format class: parsing and renderinig dates ------------
</span>
<span class="comment">-- short field names, explicit os.date names, and a mask for allowed field repeats
</span><span class="keyword">local</span> formats = {
    d = {<span class="string">'day'</span>,{<span class="keyword">true</span>,<span class="keyword">true</span>}},
    y = {<span class="string">'year'</span>,{<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">true</span>}},
    m = {<span class="string">'month'</span>,{<span class="keyword">true</span>,<span class="keyword">true</span>}},
    H = {<span class="string">'hour'</span>,{<span class="keyword">true</span>,<span class="keyword">true</span>}},
    M = {<span class="string">'min'</span>,{<span class="keyword">true</span>,<span class="keyword">true</span>}},
    S = {<span class="string">'sec'</span>,{<span class="keyword">true</span>,<span class="keyword">true</span>}},
}

<span class="comment">--- Date.Format constructor.
</span><span class="comment">-- @string fmt. A string where the following fields are significant:
</span><span class="comment">--
</span><span class="comment">--   * d day (either d or dd)
</span><span class="comment">--   * y year (either yy or yyy)
</span><span class="comment">--   * m month (either m or mm)
</span><span class="comment">--   * H hour (either H or HH)
</span><span class="comment">--   * M minute (either M or MM)
</span><span class="comment">--   * S second (either S or SS)
</span><span class="comment">--
</span><span class="comment">-- Alternatively, if fmt is nil then this returns a flexible date parser
</span><span class="comment">-- that tries various date/time schemes in turn:
</span><span class="comment">--
</span><span class="comment">--  * [ISO 8601](http://en.wikipedia.org/wiki/ISO_8601), like <code>2010-05-10 12:35:23Z</code> or <code>2008-10-03T14:30+02</code>
</span><span class="comment">--  * times like 15:30 or 8.05pm  (assumed to be today's date)
</span><span class="comment">--  * dates like 28/10/02 (European order!) or 5 Feb 2012
</span><span class="comment">--  * month name like march or Mar (case-insensitive, first 3 letters); here the
</span><span class="comment">-- day will be 1 and the year this current year
</span><span class="comment">--
</span><span class="comment">-- A date in format 3 can be optionally followed by a time in format 2.
</span><span class="comment">-- Please see test-date.lua in the tests folder for more examples.
</span><span class="comment">-- @usage df = Date.Format("yyyy-mm-dd HH:MM:SS")
</span><span class="comment">-- @class function
</span><a id="384"></a><span class="comment">-- @name Date.Format
</span><span class="keyword">function</span> Date.Format:_init(fmt)
    <span class="keyword">if</span> <span class="keyword">not</span> fmt <span class="keyword">then</span>
        self.fmt = <span class="string">'%Y-%m-%d %H:%M:%S'</span>
        self.outf = self.fmt
        self.plain = <span class="keyword">true</span>
        <span class="keyword">return</span>
    <span class="keyword">end</span>
    <span class="keyword">local</span> append = <span class="global">table</span>.insert
    <span class="keyword">local</span> D,PLUS,OPENP,CLOSEP = <span class="string">'\001'</span>,<span class="string">'\002'</span>,<span class="string">'\003'</span>,<span class="string">'\004'</span>
    <span class="keyword">local</span> vars,used = {},{}
    <span class="keyword">local</span> patt,outf = {},{}
    <span class="keyword">local</span> i = <span class="number">1</span>
    <span class="keyword">while</span> i &lt; #fmt <span class="keyword">do</span>
        <span class="keyword">local</span> ch = fmt:sub(i,i)
        <span class="keyword">local</span> df = formats[ch]
        <span class="keyword">if</span> df <span class="keyword">then</span>
            <span class="keyword">if</span> used[ch] <span class="keyword">then</span> error(<span class="string">"field appeared twice: "</span>..ch,<span class="number">4</span>) <span class="keyword">end</span>
            used[ch] = <span class="keyword">true</span>
            <span class="comment">-- this field may be repeated
</span>            <span class="keyword">local</span> _,inext = fmt:find(ch..<span class="string">'+'</span>,i+<span class="number">1</span>)
            <span class="keyword">local</span> cnt = <span class="keyword">not</span> _ <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> inext-i+<span class="number">1</span>
            <span class="keyword">if</span> <span class="keyword">not</span> df[<span class="number">2</span>][cnt] <span class="keyword">then</span> error(<span class="string">"wrong number of fields: "</span>..ch,<span class="number">4</span>) <span class="keyword">end</span>
            <span class="comment">-- single chars mean 'accept more than one digit'
</span>            <span class="keyword">local</span> p = cnt==<span class="number">1</span> <span class="keyword">and</span> (D..PLUS) <span class="keyword">or</span> (D):rep(cnt)
            append(patt,OPENP..p..CLOSEP)
            append(vars,ch)
            <span class="keyword">if</span> ch == <span class="string">'y'</span> <span class="keyword">then</span>
                append(outf,cnt==<span class="number">2</span> <span class="keyword">and</span> <span class="string">'%y'</span> <span class="keyword">or</span> <span class="string">'%Y'</span>)
            <span class="keyword">else</span>
                append(outf,<span class="string">'%'</span>..ch)
            <span class="keyword">end</span>
            i = i + cnt
        <span class="keyword">else</span>
            append(patt,ch)
            append(outf,ch)
            i = i + <span class="number">1</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="comment">-- escape any magic characters
</span>    fmt = utils.escape(<span class="global">table</span>.concat(patt))
   <span class="comment">-- fmt = table.concat(patt):gsub('[%-%.%+%[%]%(%)%$%^%%%?%*]','%%%1')
</span>    <span class="comment">-- replace markers with their magic equivalents
</span>    fmt = fmt:gsub(D,<span class="string">'%%d'</span>):gsub(PLUS,<span class="string">'+'</span>):gsub(OPENP,<span class="string">'('</span>):gsub(CLOSEP,<span class="string">')'</span>)
    self.fmt = fmt
    self.outf = <span class="global">table</span>.concat(outf)
    self.vars = vars
<span class="keyword">end</span>

<span class="keyword">local</span> parse_date

<span class="comment">--- parse a string into a Date object.
</span><span class="comment">-- @string str a date string
</span><a id="437"></a><span class="comment">-- @return date object
</span><span class="keyword">function</span> Date.Format:parse(str)
    assert_string(<span class="number">1</span>,str)
    <span class="keyword">if</span> self.plain <span class="keyword">then</span>
        <span class="keyword">return</span> parse_date(str,self.us)
    <span class="keyword">end</span>
    <span class="keyword">local</span> res = {str:match(self.fmt)}
    <span class="keyword">if</span> #res==<span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span>, <span class="string">'cannot parse '</span>..str <span class="keyword">end</span>
    <span class="keyword">local</span> tab = {}
    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="global">ipairs</span>(self.vars) <span class="keyword">do</span>
        <span class="keyword">local</span> name = formats[v][<span class="number">1</span>] <span class="comment">-- e.g. 'y' becomes 'year'
</span>        tab[name] = <span class="global">tonumber</span>(res[i])
    <span class="keyword">end</span>
    <span class="comment">-- os.date() requires these fields; if not present, we assume
</span>    <span class="comment">-- that the time set is for the current day.
</span>    <span class="keyword">if</span> <span class="keyword">not</span> (tab.year <span class="keyword">and</span> tab.month <span class="keyword">and</span> tab.day) <span class="keyword">then</span>
        <span class="keyword">local</span> today = Date()
        tab.year = tab.year <span class="keyword">or</span> today:year()
        tab.month = tab.month <span class="keyword">or</span> today:month()
        tab.day = tab.day <span class="keyword">or</span> today:day()
    <span class="keyword">end</span>
    <span class="keyword">local</span> Y = tab.year
    <span class="keyword">if</span> Y &lt; <span class="number">100</span> <span class="keyword">then</span> <span class="comment">-- classic Y2K pivot
</span>        tab.year = Y + (Y &lt; <span class="number">35</span> <span class="keyword">and</span> <span class="number">2000</span> <span class="keyword">or</span> <span class="number">1999</span>)
    <span class="keyword">elseif</span> <span class="keyword">not</span> Y <span class="keyword">then</span>
        tab.year = <span class="number">1970</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> Date(tab)
<span class="keyword">end</span>

<span class="comment">--- convert a Date object into a string.
</span><span class="comment">-- @param d a date object, or a time value as returned by <a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.time">os.time</a>
</span><a id="469"></a><span class="comment">-- @return string
</span><span class="keyword">function</span> Date.Format:<span class="global">tostring</span>(d)
    <span class="keyword">local</span> tm = <span class="global">type</span>(d) == <span class="string">'number'</span> <span class="keyword">and</span> d <span class="keyword">or</span> d.time
    <span class="keyword">return</span> os_date(self.outf,tm)
<span class="keyword">end</span>

<a id="475"></a><span class="comment">--- force US order in dates like 9/11/2001
</span><span class="keyword">function</span> Date.Format:US_order(yesno)
    self.us = yesno
<span class="keyword">end</span>

<span class="comment">--local months = {jan=1,feb=2,mar=3,apr=4,may=5,jun=6,jul=7,aug=8,sep=9,oct=10,nov=11,dec=12}
</span><span class="keyword">local</span> months

<span class="comment">--[[
Allowed patterns:
- [day] [monthname] [year] [time]
- [day]/[month][/year] [time]

]]</span>


<span class="keyword">local</span> is_word = stringx.isalpha
<span class="keyword">local</span> is_number = stringx.isdigit
<span class="keyword">local</span> <span class="keyword">function</span> tonum(s,l1,l2,kind)
    kind = kind <span class="keyword">or</span> <span class="string">''</span>
    <span class="keyword">local</span> n = <span class="global">tonumber</span>(s)
    <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> error((<span class="string">"%snot a number: '%s'"</span>):format(kind,s)) <span class="keyword">end</span>
    <span class="keyword">if</span> n &lt; l1 <span class="keyword">or</span> n &gt; l2 <span class="keyword">then</span>
        error((<span class="string">"%s out of range: %s is not between %d and %d"</span>):format(kind,s,l1,l2))
    <span class="keyword">end</span>
    <span class="keyword">return</span> n
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span>  parse_iso_end(p,ns,sec)
    <span class="comment">-- may be fractional part of seconds
</span>    <span class="keyword">local</span> _,nfrac,secfrac = p:find(<span class="string">'^%.%d+'</span>,ns+<span class="number">1</span>)
    <span class="keyword">if</span> secfrac <span class="keyword">then</span>
        sec = sec .. secfrac
        p = p:sub(nfrac+<span class="number">1</span>)
    <span class="keyword">else</span>
        p = p:sub(ns+<span class="number">1</span>)
    <span class="keyword">end</span>
    <span class="comment">-- ISO 8601 dates may end in Z (for UTC) or [+-][isotime]
</span>    <span class="comment">-- (we're working with the date as lower case, hence 'z')
</span>    <span class="keyword">if</span> p:match <span class="string">'z$'</span> <span class="keyword">then</span> <span class="keyword">return</span> sec, {h=<span class="number">0</span>,m=<span class="number">0</span>} <span class="keyword">end</span> <span class="comment">-- we're UTC!
</span>    p = p:gsub(<span class="string">':'</span>,<span class="string">''</span>) <span class="comment">-- turn 00:30 to 0030
</span>    <span class="keyword">local</span> _,_,sign,offs = p:find(<span class="string">'^([%+%-])(%d+)'</span>)
    <span class="keyword">if</span> <span class="keyword">not</span> sign <span class="keyword">then</span> <span class="keyword">return</span> sec, <span class="keyword">nil</span> <span class="keyword">end</span> <span class="comment">-- not UTC
</span>
    <span class="keyword">if</span> #offs == <span class="number">2</span> <span class="keyword">then</span> offs = offs .. <span class="string">'00'</span> <span class="keyword">end</span> <span class="comment">-- 01 to 0100
</span>    <span class="keyword">local</span> tz = { h = <span class="global">tonumber</span>(offs:sub(<span class="number">1</span>,<span class="number">2</span>)), m = <span class="global">tonumber</span>(offs:sub(<span class="number">3</span>,<span class="number">4</span>)) }
    <span class="keyword">if</span> sign == <span class="string">'-'</span> <span class="keyword">then</span> tz.h = -tz.h; tz.m = -tz.m <span class="keyword">end</span>
    <span class="keyword">return</span> sec, tz
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> parse_date_unsafe (s,US)
    s = s:gsub(<span class="string">'T'</span>,<span class="string">' '</span>) <span class="comment">-- ISO 8601
</span>    <span class="keyword">local</span> parts = stringx.split(s:lower())
    <span class="keyword">local</span> i,p = <span class="number">1</span>,parts[<span class="number">1</span>]
    <span class="keyword">local</span> <span class="keyword">function</span> nextp() i = i + <span class="number">1</span>; p = parts[i] <span class="keyword">end</span>
    <span class="keyword">local</span> year,min,hour,sec,apm
    <span class="keyword">local</span> tz
    <span class="keyword">local</span> _,nxt,day, month = p:find <span class="string">'^(%d+)/(%d+)'</span>
    <span class="keyword">if</span> day <span class="keyword">then</span>
        <span class="comment">-- swop for US case
</span>        <span class="keyword">if</span> US <span class="keyword">then</span>
            day, month = month, day
        <span class="keyword">end</span>
        _,_,year = p:find(<span class="string">'^/(%d+)'</span>,nxt+<span class="number">1</span>)
        nextp()
    <span class="keyword">else</span> <span class="comment">-- ISO
</span>        year,month,day = p:match(<span class="string">'^(%d+)%-(%d+)%-(%d+)'</span>)
        <span class="keyword">if</span> year <span class="keyword">then</span>
            nextp()
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> p <span class="keyword">and</span> <span class="keyword">not</span> year <span class="keyword">and</span> is_number(p) <span class="keyword">then</span> <span class="comment">-- has to be date
</span>        <span class="keyword">if</span> #p &lt; <span class="number">4</span> <span class="keyword">then</span>
            day = p
            nextp()
        <span class="keyword">else</span> <span class="comment">-- unless it looks like a 24-hour time
</span>            year = <span class="keyword">true</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> p <span class="keyword">and</span> is_word(p) <span class="keyword">then</span>
        p = p:sub(<span class="number">1</span>,<span class="number">3</span>)
        <span class="keyword">if</span> <span class="keyword">not</span> months <span class="keyword">then</span>
            <span class="keyword">local</span> ld, day1 = parse_date_unsafe <span class="string">'2000-12-31'</span>, {day=<span class="number">1</span>}
            months = {}
            <span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">12</span> <span class="keyword">do</span>
                ld = ld:last_day()
                ld:add(day1)
                <span class="keyword">local</span> mon = ld:month_name():lower()
                months [mon] = i
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">local</span> mon = months[p]
        <span class="keyword">if</span> mon <span class="keyword">then</span>
            month = mon
        <span class="keyword">else</span> error(<span class="string">"not a month: "</span> .. p) <span class="keyword">end</span>
        nextp()
    <span class="keyword">end</span>
    <span class="keyword">if</span> p <span class="keyword">and</span> <span class="keyword">not</span> year <span class="keyword">and</span> is_number(p) <span class="keyword">then</span>
        year = p
        nextp()
    <span class="keyword">end</span>

    <span class="keyword">if</span> p <span class="keyword">then</span> <span class="comment">-- time is hh:mm[:ss], hhmm[ss] or H.M[am|pm]
</span>        _,nxt,hour,min = p:find <span class="string">'^(%d+):(%d+)'</span>
        <span class="keyword">local</span> ns
        <span class="keyword">if</span> nxt <span class="keyword">then</span> <span class="comment">-- are there seconds?
</span>            _,ns,sec = p:find (<span class="string">'^:(%d+)'</span>,nxt+<span class="number">1</span>)
            <span class="comment">--if ns then
</span>                sec,tz = parse_iso_end(p,ns <span class="keyword">or</span> nxt,sec)
            <span class="comment">--end
</span>        <span class="keyword">else</span> <span class="comment">-- might be h.m
</span>            _,ns,hour,min = p:find <span class="string">'^(%d+)%.(%d+)'</span>
            <span class="keyword">if</span> ns <span class="keyword">then</span>
                apm = p:match <span class="string">'[ap]m$'</span>
            <span class="keyword">else</span>  <span class="comment">-- or hhmm[ss]
</span>                <span class="keyword">local</span> hourmin
                _,nxt,hourmin = p:find (<span class="string">'^(%d+)'</span>)
                <span class="keyword">if</span> nxt <span class="keyword">then</span>
                   hour = hourmin:sub(<span class="number">1</span>,<span class="number">2</span>)
                   min = hourmin:sub(<span class="number">3</span>,<span class="number">4</span>)
                   sec = hourmin:sub(<span class="number">5</span>,<span class="number">6</span>)
                   <span class="keyword">if</span> #sec == <span class="number">0</span> <span class="keyword">then</span> sec = <span class="keyword">nil</span> <span class="keyword">end</span>
                   sec,tz = parse_iso_end(p,nxt,sec)
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">local</span> today
    <span class="keyword">if</span> year == <span class="keyword">true</span> <span class="keyword">then</span> year = <span class="keyword">nil</span> <span class="keyword">end</span>
    <span class="keyword">if</span> <span class="keyword">not</span> (year <span class="keyword">and</span> month <span class="keyword">and</span> day) <span class="keyword">then</span>
        today = Date()
    <span class="keyword">end</span>
    day = day <span class="keyword">and</span> tonum(day,<span class="number">1</span>,<span class="number">31</span>,<span class="string">'day'</span>) <span class="keyword">or</span> (month <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> today:day())
    month = month <span class="keyword">and</span> tonum(month,<span class="number">1</span>,<span class="number">12</span>,<span class="string">'month'</span>) <span class="keyword">or</span> today:month()
    year = year <span class="keyword">and</span> <span class="global">tonumber</span>(year) <span class="keyword">or</span> today:year()
    <span class="keyword">if</span> year &lt; <span class="number">100</span> <span class="keyword">then</span> <span class="comment">-- two-digit year pivot around year &lt; 2035
</span>        year = year + (year &lt; <span class="number">35</span> <span class="keyword">and</span> <span class="number">2000</span> <span class="keyword">or</span> <span class="number">1900</span>)
    <span class="keyword">end</span>
    hour = hour <span class="keyword">and</span> tonum(hour,<span class="number">0</span>,apm <span class="keyword">and</span> <span class="number">12</span> <span class="keyword">or</span> <span class="number">24</span>,<span class="string">'hour'</span>) <span class="keyword">or</span> <span class="number">12</span>
    <span class="keyword">if</span> apm == <span class="string">'pm'</span> <span class="keyword">then</span>
        hour = hour + <span class="number">12</span>
    <span class="keyword">end</span>
    min = min <span class="keyword">and</span> tonum(min,<span class="number">0</span>,<span class="number">59</span>) <span class="keyword">or</span> <span class="number">0</span>
    sec = sec <span class="keyword">and</span> tonum(sec,<span class="number">0</span>,<span class="number">60</span>) <span class="keyword">or</span> <span class="number">0</span>  <span class="comment">--60 used to indicate leap second
</span>    <span class="keyword">local</span> res = Date {year = year, month = month, day = day, hour = hour, min = min, sec = sec}
    <span class="keyword">if</span> tz <span class="keyword">then</span> <span class="comment">-- ISO 8601 UTC time
</span>        res:add {hour = -tz.h}
        <span class="keyword">if</span> tz.m ~= <span class="number">0</span> <span class="keyword">then</span> res:add {min = -tz.m} <span class="keyword">end</span>
        res.utc = <span class="keyword">true</span>
        <span class="comment">-- we're in UTC, so let's go local...
</span>        res = res:toLocal()
    <span class="keyword">end</span>
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="keyword">function</span> parse_date (s)
    <span class="keyword">local</span> ok, d = <span class="global">pcall</span>(parse_date_unsafe,s)
    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span> <span class="comment">-- error
</span>        d = d:gsub(<span class="string">'.-:%d+: '</span>,<span class="string">''</span>)
        <span class="keyword">return</span> <span class="keyword">nil</span>, d
    <span class="keyword">else</span>
        <span class="keyword">return</span> d
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">return</span> Date</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2014-11-01 18:36:39 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
