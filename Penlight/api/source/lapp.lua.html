<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Penlight Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Penlight</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../source/app.lua.html">app.lua</a></li>
  <li><a href="../source/array2d.lua.html">array2d.lua</a></li>
  <li><a href="../source/class.lua.html">class.lua</a></li>
  <li><a href="../source/compat.lua.html">compat.lua</a></li>
  <li><a href="../source/comprehension.lua.html">comprehension.lua</a></li>
  <li><a href="../source/config.lua.html">config.lua</a></li>
  <li><a href="../source/data.lua.html">data.lua</a></li>
  <li><a href="../source/date.lua.html">date.lua</a></li>
  <li><a href="../source/dir.lua.html">dir.lua</a></li>
  <li><a href="../source/file.lua.html">file.lua</a></li>
  <li><a href="../source/func.lua.html">func.lua</a></li>
  <li><a href="../source/import_into.lua.html">import_into.lua</a></li>
  <li><a href="../source/init.lua.html">init.lua</a></li>
  <li><a href="../source/input.lua.html">input.lua</a></li>
  <li><strong>lapp.lua</strong></li>
  <li><a href="../source/lexer.lua.html">lexer.lua</a></li>
  <li><a href="../source/list.lua.html">list.lua</a></li>
  <li><a href="../source/luabalanced.lua.html">luabalanced.lua</a></li>
  <li><a href="../source/map.lua.html">map.lua</a></li>
  <li><a href="../source/multimap.lua.html">multimap.lua</a></li>
  <li><a href="../source/operator.lua.html">operator.lua</a></li>
  <li><a href="../source/orderedmap.lua.html">orderedmap.lua</a></li>
  <li><a href="../source/path.lua.html">path.lua</a></li>
  <li><a href="../source/permute.lua.html">permute.lua</a></li>
  <li><a href="../source/pretty.lua.html">pretty.lua</a></li>
  <li><a href="../source/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../source/seq.lua.html">seq.lua</a></li>
  <li><a href="../source/set.lua.html">set.lua</a></li>
  <li><a href="../source/sip.lua.html">sip.lua</a></li>
  <li><a href="../source/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../source/strict.lua.html">strict.lua</a></li>
  <li><a href="../source/stringio.lua.html">stringio.lua</a></li>
  <li><a href="../source/stringx.lua.html">stringx.lua</a></li>
  <li><a href="../source/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../source/tablex.lua.html">tablex.lua</a></li>
  <li><a href="../source/template.lua.html">template.lua</a></li>
  <li><a href="../source/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../source/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../source/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../source/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../source/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../source/test.lua.html">test.lua</a></li>
  <li><a href="../source/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../source/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../source/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../source/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../source/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../source/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../source/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../source/text.lua.html">text.lua</a></li>
  <li><a href="../source/types.lua.html">types.lua</a></li>
  <li><a href="../source/url.lua.html">url.lua</a></li>
  <li><a href="../source/utils.lua.html">utils.lua</a></li>
  <li><a href="../source/which.lua.html">which.lua</a></li>
  <li><a href="../source/xml.lua.html">xml.lua</a></li>
</ul>
<h2>Libraries</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../libraries/pl.html">pl</a></li>
  <li><a href="../libraries/pl.app.html">pl.app</a></li>
  <li><a href="../libraries/pl.array2d.html">pl.array2d</a></li>
  <li><a href="../libraries/pl.class.html">pl.class</a></li>
  <li><a href="../libraries/pl.compat.html">pl.compat</a></li>
  <li><a href="../libraries/pl.comprehension.html">pl.comprehension</a></li>
  <li><a href="../libraries/pl.config.html">pl.config</a></li>
  <li><a href="../libraries/pl.data.html">pl.data</a></li>
  <li><a href="../libraries/pl.dir.html">pl.dir</a></li>
  <li><a href="../libraries/pl.file.html">pl.file</a></li>
  <li><a href="../libraries/pl.func.html">pl.func</a></li>
  <li><a href="../libraries/pl.import_into.html">pl.import_into</a></li>
  <li><a href="../libraries/pl.input.html">pl.input</a></li>
  <li><a href="../libraries/pl.lapp.html">pl.lapp</a></li>
  <li><a href="../libraries/pl.lexer.html">pl.lexer</a></li>
  <li><a href="../libraries/pl.luabalanced.html">pl.luabalanced</a></li>
  <li><a href="../libraries/pl.operator.html">pl.operator</a></li>
  <li><a href="../libraries/pl.path.html">pl.path</a></li>
  <li><a href="../libraries/pl.permute.html">pl.permute</a></li>
  <li><a href="../libraries/pl.pretty.html">pl.pretty</a></li>
  <li><a href="../libraries/pl.seq.html">pl.seq</a></li>
  <li><a href="../libraries/pl.sip.html">pl.sip</a></li>
  <li><a href="../libraries/pl.strict.html">pl.strict</a></li>
  <li><a href="../libraries/pl.stringio.html">pl.stringio</a></li>
  <li><a href="../libraries/pl.stringx.html">pl.stringx</a></li>
  <li><a href="../libraries/pl.tablex.html">pl.tablex</a></li>
  <li><a href="../libraries/pl.template.html">pl.template</a></li>
  <li><a href="../libraries/pl.test.html">pl.test</a></li>
  <li><a href="../libraries/pl.text.html">pl.text</a></li>
  <li><a href="../libraries/pl.types.html">pl.types</a></li>
  <li><a href="../libraries/pl.url.html">pl.url</a></li>
  <li><a href="../libraries/pl.utils.html">pl.utils</a></li>
  <li><a href="../libraries/pl.xml.html">pl.xml</a></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/pl.Date.html">pl.Date</a></li>
  <li><a href="../classes/pl.List.html">pl.List</a></li>
  <li><a href="../classes/pl.Map.html">pl.Map</a></li>
  <li><a href="../classes/pl.MultiMap.html">pl.MultiMap</a></li>
  <li><a href="../classes/pl.OrderedMap.html">pl.OrderedMap</a></li>
  <li><a href="../classes/pl.Set.html">pl.Set</a></li>
</ul>
<h2>Manual</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../manual/01-introduction.md.html">Introduction</a></li>
  <li><a href="../manual/02-arrays.md.html">Tables and Arrays</a></li>
  <li><a href="../manual/03-strings.md.html">Strings. Higher-level operations on strings.</a></li>
  <li><a href="../manual/04-paths.md.html">Paths and Directories</a></li>
  <li><a href="../manual/05-dates.md.html">Date and Time</a></li>
  <li><a href="../manual/06-data.md.html">Data</a></li>
  <li><a href="../manual/07-functional.md.html">Functional Programming</a></li>
  <li><a href="../manual/08-additional.md.html">Additional Libraries</a></li>
  <li><a href="../manual/09-discussion.md.html">Technical Choices</a></li>
</ul>
<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../examples/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../examples/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../examples/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../examples/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../examples/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../examples/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../examples/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../examples/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../examples/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../examples/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../examples/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../examples/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../examples/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../examples/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../examples/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../examples/which.lua.html">which.lua</a></li>
</ul>

</div>

<div id="content">

    <h2>lapp.lua</h2>
<pre>
<span class="comment">--- Simple command-line parsing using human-readable specification.
</span><span class="comment">-- Supports GNU-style parameters.
</span><span class="comment">--
</span><span class="comment">--      lapp = require 'pl.lapp'
</span><span class="comment">--      local args = lapp [[
</span><span class="comment">--      Does some calculations
</span><span class="comment">--        -o,--offset (default 0.0)  Offset to add to scaled number
</span><span class="comment">--        -s,--scale  (number)  Scaling factor
</span><span class="comment">--         &lt;number&gt;; (number )  Number to be scaled
</span><span class="comment">--      ]]
</span><span class="comment">--
</span><span class="comment">--      print(args.offset + args.scale * args.number)
</span><span class="comment">--
</span><span class="comment">-- Lines begining with '-' are flags; there may be a short and a long name;
</span><span class="comment">-- lines begining wih '&lt;var&gt;' are arguments.  Anything in parens after
</span><span class="comment">-- the flag/argument is either a default, a type name or a range constraint.
</span><span class="comment">--
</span><span class="comment">-- See <a href="../manual/08-additional.md.html#Command_line_Programs_with_Lapp">the Guide</a>
</span><span class="comment">--
</span><span class="comment">-- Dependencies: <a href="../libraries/pl.sip.html#">pl.sip</a>
</span><span class="comment">-- @module pl.lapp
</span>
<span class="keyword">local</span> status,sip = <span class="global">pcall</span>(<span class="global">require</span>,<span class="string">'pl.sip'</span>)
<span class="keyword">if</span> <span class="keyword">not</span> status <span class="keyword">then</span>
    sip = <span class="global">require</span> <span class="string">'sip'</span>
<span class="keyword">end</span>
<span class="keyword">local</span> match = sip.match_at_start
<span class="keyword">local</span> append,tinsert = <span class="global">table</span>.insert,<span class="global">table</span>.insert

sip.custom_pattern(<span class="string">'X'</span>,<span class="string">'(%a[%w_%-]*)'</span>)

<span class="keyword">local</span> <span class="keyword">function</span> lines(s) <span class="keyword">return</span> s:gmatch(<span class="string">'([^\n]*)\n'</span>) <span class="keyword">end</span>
<span class="keyword">local</span> <span class="keyword">function</span> lstrip(str)  <span class="keyword">return</span> str:gsub(<span class="string">'^%s+'</span>,<span class="string">''</span>)  <span class="keyword">end</span>
<span class="keyword">local</span> <span class="keyword">function</span> strip(str)  <span class="keyword">return</span> lstrip(str):gsub(<span class="string">'%s+$'</span>,<span class="string">''</span>) <span class="keyword">end</span>
<span class="keyword">local</span> <span class="keyword">function</span> at(s,k)  <span class="keyword">return</span> s:sub(k,k) <span class="keyword">end</span>
<span class="keyword">local</span> <span class="keyword">function</span> isdigit(s) <span class="keyword">return</span> s:find(<span class="string">'^%d+$'</span>) == <span class="number">1</span> <span class="keyword">end</span>

<span class="keyword">local</span> lapp = {}

<span class="keyword">local</span> open_files,parms,aliases,parmlist,usage,windows,script

lapp.callback = <span class="keyword">false</span> <span class="comment">-- keep Strict happy
</span>
<span class="keyword">local</span> filetypes = {
    stdin = {<span class="global">io</span>.stdin,<span class="string">'file-in'</span>}, stdout = {<span class="global">io</span>.stdout,<span class="string">'file-out'</span>},
    stderr = {<span class="global">io</span>.stderr,<span class="string">'file-out'</span>}
}

<span class="comment">--- controls whether to dump usage on error.
</span><a id="51"></a><span class="comment">-- Defaults to true
</span>lapp.show_usage_error = <span class="keyword">true</span>

<span class="comment">--- quit this script immediately.
</span><span class="comment">-- @string msg optional message
</span><a id="56"></a><span class="comment">-- @bool no_usage suppress 'usage' display
</span><span class="keyword">function</span> lapp.quit(msg,no_usage)
    <span class="keyword">if</span> no_usage == <span class="string">'throw'</span> <span class="keyword">then</span>
        error(msg)
    <span class="keyword">end</span>
    <span class="keyword">if</span> msg <span class="keyword">then</span>
        <span class="global">io</span>.stderr:write(msg..<span class="string">'\n\n'</span>)
    <span class="keyword">end</span>
    <span class="keyword">if</span> <span class="keyword">not</span> no_usage <span class="keyword">then</span>
        <span class="global">io</span>.stderr:write(usage)
    <span class="keyword">end</span>
    <span class="global">os</span>.exit(<span class="number">1</span>)
<span class="keyword">end</span>

<span class="comment">--- print an error to stderr and quit.
</span><span class="comment">-- @string msg a message
</span><a id="72"></a><span class="comment">-- @bool no_usage suppress 'usage' display
</span><span class="keyword">function</span> lapp.error(msg,no_usage)
    <span class="keyword">if</span> <span class="keyword">not</span> lapp.show_usage_error <span class="keyword">then</span>
        no_usage = <span class="keyword">true</span>
    <span class="keyword">elseif</span> lapp.show_usage_error == <span class="string">'throw'</span> <span class="keyword">then</span>
        no_usage = <span class="string">'throw'</span>
    <span class="keyword">end</span>
    lapp.quit(script..<span class="string">': '</span>..msg,no_usage)
<span class="keyword">end</span>

<span class="comment">--- open a file.
</span><span class="comment">-- This will quit on error, and keep a list of file objects for later cleanup.
</span><span class="comment">-- @string file filename
</span><a id="85"></a><span class="comment">-- @string[opt] opt same as second parameter of <a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.open">io.open</a>
</span><span class="keyword">function</span> lapp.open (file,opt)
    <span class="keyword">local</span> val,err = <span class="global">io</span>.open(file,opt)
    <span class="keyword">if</span> <span class="keyword">not</span> val <span class="keyword">then</span> lapp.error(err,<span class="keyword">true</span>) <span class="keyword">end</span>
    append(open_files,val)
    <span class="keyword">return</span> val
<span class="keyword">end</span>

<span class="comment">--- quit if the condition is false.
</span><span class="comment">-- @bool condn a condition
</span><a id="95"></a><span class="comment">-- @string msg message text
</span><span class="keyword">function</span> lapp.<span class="global">assert</span>(condn,msg)
    <span class="keyword">if</span> <span class="keyword">not</span> condn <span class="keyword">then</span>
        lapp.error(msg)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> range_check(x,min,max,parm)
    lapp.<span class="global">assert</span>(min &lt;= x <span class="keyword">and</span> max &gt;= x,parm..<span class="string">' out of range'</span>)
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> xtonumber(s)
    <span class="keyword">local</span> val = <span class="global">tonumber</span>(s)
    <span class="keyword">if</span> <span class="keyword">not</span> val <span class="keyword">then</span> lapp.error(<span class="string">"unable to convert to number: "</span>..s) <span class="keyword">end</span>
    <span class="keyword">return</span> val
<span class="keyword">end</span>

<span class="keyword">local</span> types = {}

<span class="keyword">local</span> builtin_types = {<span class="global">string</span>=<span class="keyword">true</span>,number=<span class="keyword">true</span>,[<span class="string">'file-in'</span>]=<span class="string">'file'</span>,[<span class="string">'file-out'</span>]=<span class="string">'file'</span>,boolean=<span class="keyword">true</span>}

<span class="keyword">local</span> <span class="keyword">function</span> convert_parameter(ps,val)
    <span class="keyword">if</span> ps.converter <span class="keyword">then</span>
        val = ps.converter(val)
    <span class="keyword">end</span>
    <span class="keyword">if</span> ps.<span class="global">type</span> == <span class="string">'number'</span> <span class="keyword">then</span>
        val = xtonumber(val)
    <span class="keyword">elseif</span> builtin_types[ps.<span class="global">type</span>] == <span class="string">'file'</span> <span class="keyword">then</span>
        val = lapp.open(val,(ps.<span class="global">type</span> == <span class="string">'file-in'</span> <span class="keyword">and</span> <span class="string">'r'</span>) <span class="keyword">or</span> <span class="string">'w'</span> )
    <span class="keyword">elseif</span> ps.<span class="global">type</span> == <span class="string">'boolean'</span> <span class="keyword">then</span>
        <span class="keyword">return</span> val
    <span class="keyword">end</span>
    <span class="keyword">if</span> ps.constraint <span class="keyword">then</span>
        ps.constraint(val)
    <span class="keyword">end</span>
    <span class="keyword">return</span> val
<span class="keyword">end</span>

<span class="comment">--- add a new type to Lapp. These appear in parens after the value like
</span><span class="comment">-- a range constraint, e.g. '&lt;ival&gt; (integer) Process PID'
</span><span class="comment">-- @string name name of type
</span><span class="comment">-- @param converter either a function to convert values, or a Lua type name.
</span><span class="comment">-- @func[opt] constraint optional function to verify values, should use lapp.error
</span><a id="138"></a><span class="comment">-- if failed.
</span><span class="keyword">function</span> lapp.add_type (name,converter,constraint)
    types[name] = {converter=converter,constraint=constraint}
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> force_short(short)
    lapp.<span class="global">assert</span>(#short==<span class="number">1</span>,short..<span class="string">": short parameters should be one character"</span>)
<span class="keyword">end</span>

<span class="comment">-- deducing type of variable from default value;
</span><span class="keyword">local</span> <span class="keyword">function</span> process_default (sval,vtype)
    <span class="keyword">local</span> val
    <span class="keyword">if</span> <span class="keyword">not</span> vtype <span class="keyword">or</span> vtype == <span class="string">'number'</span> <span class="keyword">then</span>
        val = <span class="global">tonumber</span>(sval)
    <span class="keyword">end</span>
    <span class="keyword">if</span> val <span class="keyword">then</span> <span class="comment">-- we have a number!
</span>        <span class="keyword">return</span> val,<span class="string">'number'</span>
    <span class="keyword">elseif</span> filetypes[sval] <span class="keyword">then</span>
        <span class="keyword">local</span> ft = filetypes[sval]
        <span class="keyword">return</span> ft[<span class="number">1</span>],ft[<span class="number">2</span>]
    <span class="keyword">else</span>
        <span class="keyword">if</span> sval == <span class="string">'true'</span> <span class="keyword">and</span> <span class="keyword">not</span> vtype <span class="keyword">then</span>
            <span class="keyword">return</span> <span class="keyword">true</span>, <span class="string">'boolean'</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> sval:match <span class="string">'^["\']'</span> <span class="keyword">then</span> sval = sval:sub(<span class="number">2</span>,-<span class="number">2</span>) <span class="keyword">end</span>
        <span class="keyword">return</span> sval,vtype <span class="keyword">or</span> <span class="string">'string'</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- process a Lapp options string.
</span><span class="comment">-- Usually called as <code>lapp()</code>.
</span><span class="comment">-- @string str the options text
</span><span class="comment">-- @tparam {string} args a table of arguments (default is <code>_G.arg</code>)
</span><a id="171"></a><span class="comment">-- @return a table with parameter-value pairs
</span><span class="keyword">function</span> lapp.process_options_string(str,args)
    <span class="keyword">local</span> results = {}
    <span class="keyword">local</span> opts = {at_start=<span class="keyword">true</span>}
    <span class="keyword">local</span> varargs
    <span class="keyword">local</span> arg = args <span class="keyword">or</span> _G.arg
    open_files = {}
    parms = {}
    aliases = {}
    parmlist = {}

    <span class="keyword">local</span> <span class="keyword">function</span> check_varargs(s)
        <span class="keyword">local</span> res,cnt = s:gsub(<span class="string">'^%.%.%.%s*'</span>,<span class="string">''</span>)
        <span class="keyword">return</span> res, (cnt &gt; <span class="number">0</span>)
    <span class="keyword">end</span>

    <span class="keyword">local</span> <span class="keyword">function</span> set_result(ps,parm,val)
        parm = <span class="global">type</span>(parm) == <span class="string">"string"</span> <span class="keyword">and</span> parm:gsub(<span class="string">"%W"</span>, <span class="string">"_"</span>) <span class="keyword">or</span> parm <span class="comment">-- so foo-bar becomes foo_bar in Lua
</span>        <span class="keyword">if</span> <span class="keyword">not</span> ps.varargs <span class="keyword">then</span>
            results[parm] = val
        <span class="keyword">else</span>
            <span class="keyword">if</span> <span class="keyword">not</span> results[parm] <span class="keyword">then</span>
                results[parm] = { val }
            <span class="keyword">else</span>
                append(results[parm],val)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    usage = str

    <span class="keyword">for</span> line <span class="keyword">in</span> lines(str) <span class="keyword">do</span>
        <span class="keyword">local</span> res = {}
        <span class="keyword">local</span> optspec,optparm,i1,i2,defval,vtype,constraint,rest
        line = lstrip(line)
        <span class="keyword">local</span> <span class="keyword">function</span> check(str)
            <span class="keyword">return</span> match(str,line,res)
        <span class="keyword">end</span>

        <span class="comment">-- flags: either '-&lt;short&gt;', '-&lt;short&gt;,--&lt;long&gt;' or '--&lt;long&gt;'
</span>        <span class="keyword">if</span> check <span class="string">'-$v{short}, --$o{long} $'</span> <span class="keyword">or</span> check <span class="string">'-$v{short} $'</span> <span class="keyword">or</span> check <span class="string">'--$o{long} $'</span> <span class="keyword">then</span>
            <span class="keyword">if</span> res.long <span class="keyword">then</span>
                optparm = res.long:gsub(<span class="string">'[^%w%-]'</span>,<span class="string">'_'</span>)  <span class="comment">-- I'm not sure the $o pattern will let anything else through?
</span>                <span class="keyword">if</span> res.short <span class="keyword">then</span> aliases[res.short] = optparm  <span class="keyword">end</span>
            <span class="keyword">else</span>
                optparm = res.short
            <span class="keyword">end</span>
            <span class="keyword">if</span> res.short <span class="keyword">and</span> <span class="keyword">not</span> lapp.slack <span class="keyword">then</span> force_short(res.short) <span class="keyword">end</span>
            res.rest, varargs = check_varargs(res.rest)
        <span class="keyword">elseif</span> check <span class="string">'$&lt;{name} $'</span>  <span class="keyword">then</span> <span class="comment">-- is it &lt;parameter_name&gt;?
</span>            <span class="comment">-- so &lt;input file...&gt; becomes input_file ...
</span>            optparm,rest = res.name:match <span class="string">'([^%.]+)(.*)'</span>
            optparm = optparm:gsub(<span class="string">'%A'</span>,<span class="string">'_'</span>)
            varargs = rest == <span class="string">'...'</span>
            append(parmlist,optparm)
        <span class="keyword">end</span>
        <span class="comment">-- this is not a pure doc line and specifies the flag/parameter type
</span>        <span class="keyword">if</span> res.rest <span class="keyword">then</span>
            line = res.rest
            res = {}
            <span class="keyword">local</span> optional
            <span class="comment">-- do we have ([optional] [&lt;type&gt;] [default &lt;val&gt;])?
</span>            <span class="keyword">if</span> match(<span class="string">'$({def} $'</span>,line,res) <span class="keyword">or</span> match(<span class="string">'$({def}'</span>,line,res) <span class="keyword">then</span>
                <span class="keyword">local</span> typespec = strip(res.def)
                <span class="keyword">local</span> ftype, rest = typespec:match(<span class="string">'^(%S+)(.*)$'</span>)
                rest = strip(rest)
                <span class="keyword">if</span> ftype == <span class="string">'optional'</span> <span class="keyword">then</span>
                    ftype, rest = rest:match(<span class="string">'^(%S+)(.*)$'</span>)
                    rest = strip(rest)
                    optional = <span class="keyword">true</span>
                <span class="keyword">end</span>
                <span class="keyword">local</span> default
                <span class="keyword">if</span> ftype == <span class="string">'default'</span> <span class="keyword">then</span>
                    default = <span class="keyword">true</span>
                    <span class="keyword">if</span> rest == <span class="string">''</span> <span class="keyword">then</span> lapp.error(<span class="string">"value must follow default"</span>) <span class="keyword">end</span>
                <span class="keyword">else</span> <span class="comment">-- a type specification
</span>                    <span class="keyword">if</span> match(<span class="string">'$f{min}..$f{max}'</span>,ftype,res) <span class="keyword">then</span>
                        <span class="comment">-- a numerical range like 1..10
</span>                        <span class="keyword">local</span> min,max = res.min,res.max
                        vtype = <span class="string">'number'</span>
                        constraint = <span class="keyword">function</span>(x)
                            range_check(x,min,max,optparm)
                        <span class="keyword">end</span>
                    <span class="keyword">elseif</span> <span class="keyword">not</span> ftype:match <span class="string">'|'</span> <span class="keyword">then</span> <span class="comment">-- plain type
</span>                        vtype = ftype
                    <span class="keyword">else</span>
                        <span class="comment">-- 'enum' type is a string which must belong to
</span>                        <span class="comment">-- one of several distinct values
</span>                        <span class="keyword">local</span> enums = ftype
                        <span class="keyword">local</span> enump = <span class="string">'|'</span> .. enums .. <span class="string">'|'</span>
                        vtype = <span class="string">'string'</span>
                        constraint = <span class="keyword">function</span>(s)
                            lapp.<span class="global">assert</span>(enump:match(<span class="string">'|'</span>..s..<span class="string">'|'</span>),
                              <span class="string">"value '"</span>..s..<span class="string">"' not in "</span>..enums
                            )
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                res.rest = rest
                typespec = res.rest
                <span class="comment">-- optional 'default value' clause. Type is inferred as
</span>                <span class="comment">-- 'string' or 'number' if there's no explicit type
</span>                <span class="keyword">if</span> default <span class="keyword">or</span> match(<span class="string">'default $r{rest}'</span>,typespec,res) <span class="keyword">then</span>
                    defval,vtype = process_default(res.rest,vtype)
                <span class="keyword">end</span>
            <span class="keyword">else</span> <span class="comment">-- must be a plain flag, no extra parameter required
</span>                defval = <span class="keyword">false</span>
                vtype = <span class="string">'boolean'</span>
            <span class="keyword">end</span>
            <span class="keyword">local</span> ps = {
                <span class="global">type</span> = vtype,
                defval = defval,
                required = defval == <span class="keyword">nil</span> <span class="keyword">and</span> <span class="keyword">not</span> optional,
                comment = res.rest <span class="keyword">or</span> optparm,
                constraint = constraint,
                varargs = varargs
            }
            varargs = <span class="keyword">nil</span>
            <span class="keyword">if</span> types[vtype] <span class="keyword">then</span>
                <span class="keyword">local</span> converter = types[vtype].converter
                <span class="keyword">if</span> <span class="global">type</span>(converter) == <span class="string">'string'</span> <span class="keyword">then</span>
                    ps.<span class="global">type</span> = converter
                <span class="keyword">else</span>
                    ps.converter = converter
                <span class="keyword">end</span>
                ps.constraint = types[vtype].constraint
            <span class="keyword">elseif</span> <span class="keyword">not</span> builtin_types[vtype] <span class="keyword">then</span>
                lapp.error(vtype..<span class="string">" is unknown type"</span>)
            <span class="keyword">end</span>
            parms[optparm] = ps
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="comment">-- cool, we have our parms, let's parse the command line args
</span>    <span class="keyword">local</span> iparm = <span class="number">1</span>
    <span class="keyword">local</span> iextra = <span class="number">1</span>
    <span class="keyword">local</span> i = <span class="number">1</span>
    <span class="keyword">local</span> parm,ps,val

    <span class="keyword">local</span> <span class="keyword">function</span> check_parm (parm)
        <span class="keyword">local</span> eqi = parm:find <span class="string">'='</span>
        <span class="keyword">if</span> eqi <span class="keyword">then</span>
            tinsert(arg,i+<span class="number">1</span>,parm:sub(eqi+<span class="number">1</span>))
            parm = parm:sub(<span class="number">1</span>,eqi-<span class="number">1</span>)
        <span class="keyword">end</span>
        <span class="keyword">return</span> parm,eqi
    <span class="keyword">end</span>

    <span class="keyword">local</span> <span class="keyword">function</span> is_flag (parm)
        <span class="keyword">return</span> parms[aliases[parm] <span class="keyword">or</span> parm]
    <span class="keyword">end</span>

    <span class="keyword">while</span> i &lt;= #arg <span class="keyword">do</span>
        <span class="keyword">local</span> theArg = arg[i]
        <span class="keyword">local</span> res = {}
        <span class="comment">-- look for a flag, -&lt;short flags&gt; or --&lt;long flag&gt;
</span>        <span class="keyword">if</span> match(<span class="string">'--$S{long}'</span>,theArg,res) <span class="keyword">or</span> match(<span class="string">'-$S{short}'</span>,theArg,res) <span class="keyword">then</span>
            <span class="keyword">if</span> res.long <span class="keyword">then</span> <span class="comment">-- long option
</span>                parm = check_parm(res.long)
            <span class="keyword">elseif</span> #res.short == <span class="number">1</span> <span class="keyword">or</span> is_flag(res.short) <span class="keyword">then</span>
                parm = res.short
            <span class="keyword">else</span>
                <span class="keyword">local</span> parmstr,eq = check_parm(res.short)
                <span class="keyword">if</span> <span class="keyword">not</span> eq <span class="keyword">then</span>
                    parm = at(parmstr,<span class="number">1</span>)
                    <span class="keyword">local</span> flag = is_flag(parm)
                    <span class="keyword">if</span> flag <span class="keyword">and</span> flag.<span class="global">type</span> ~= <span class="string">'boolean'</span> <span class="keyword">then</span>
                    <span class="comment">--if isdigit(at(parmstr,2)) then
</span>                        <span class="comment">-- a short option followed by a digit is an exception (for AW;))
</span>                        <span class="comment">-- push ahead into the arg array
</span>                        tinsert(arg,i+<span class="number">1</span>,parmstr:sub(<span class="number">2</span>))
                    <span class="keyword">else</span>
                        <span class="comment">-- push multiple flags into the arg array!
</span>                        <span class="keyword">for</span> k = <span class="number">2</span>,#parmstr <span class="keyword">do</span>
                            tinsert(arg,i+k-<span class="number">1</span>,<span class="string">'-'</span>..at(parmstr,k))
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    parm = parmstr
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="keyword">if</span> aliases[parm] <span class="keyword">then</span> parm = aliases[parm] <span class="keyword">end</span>
            <span class="keyword">if</span> <span class="keyword">not</span> parms[parm] <span class="keyword">and</span> (parm == <span class="string">'h'</span> <span class="keyword">or</span> parm == <span class="string">'help'</span>) <span class="keyword">then</span>
                lapp.quit()
            <span class="keyword">end</span>
        <span class="keyword">else</span> <span class="comment">-- a parameter
</span>            parm = parmlist[iparm]
            <span class="keyword">if</span> <span class="keyword">not</span> parm <span class="keyword">then</span>
               <span class="comment">-- extra unnamed parameters are indexed starting at 1
</span>               parm = iextra
               ps = { <span class="global">type</span> = <span class="string">'string'</span> }
               parms[parm] = ps
               iextra = iextra + <span class="number">1</span>
            <span class="keyword">else</span>
                ps = parms[parm]
            <span class="keyword">end</span>
            <span class="keyword">if</span> <span class="keyword">not</span> ps.varargs <span class="keyword">then</span>
                iparm = iparm + <span class="number">1</span>
            <span class="keyword">end</span>
            val = theArg
        <span class="keyword">end</span>
        ps = parms[parm]
        <span class="keyword">if</span> <span class="keyword">not</span> ps <span class="keyword">then</span> lapp.error(<span class="string">"unrecognized parameter: "</span>..parm) <span class="keyword">end</span>
        <span class="keyword">if</span> ps.<span class="global">type</span> ~= <span class="string">'boolean'</span> <span class="keyword">then</span> <span class="comment">-- we need a value! This should follow
</span>            <span class="keyword">if</span> <span class="keyword">not</span> val <span class="keyword">then</span>
                i = i + <span class="number">1</span>
                val = arg[i]
            <span class="keyword">end</span>
            lapp.<span class="global">assert</span>(val,parm..<span class="string">" was expecting a value"</span>)
        <span class="keyword">else</span> <span class="comment">-- toggle boolean flags (usually false -&gt; true)
</span>            val = <span class="keyword">not</span> ps.defval
        <span class="keyword">end</span>
        ps.used = <span class="keyword">true</span>
        val = convert_parameter(ps,val)
        set_result(ps,parm,val)
        <span class="keyword">if</span> builtin_types[ps.<span class="global">type</span>] == <span class="string">'file'</span> <span class="keyword">then</span>
            set_result(ps,parm..<span class="string">'_name'</span>,theArg)
        <span class="keyword">end</span>
        <span class="keyword">if</span> lapp.callback <span class="keyword">then</span>
            lapp.callback(parm,theArg,res)
        <span class="keyword">end</span>
        i = i + <span class="number">1</span>
        val = <span class="keyword">nil</span>
    <span class="keyword">end</span>
    <span class="comment">-- check unused parms, set defaults and check if any required parameters were missed
</span>    <span class="keyword">for</span> parm,ps <span class="keyword">in</span> <span class="global">pairs</span>(parms) <span class="keyword">do</span>
        <span class="keyword">if</span> <span class="keyword">not</span> ps.used <span class="keyword">then</span>
            <span class="keyword">if</span> ps.required <span class="keyword">then</span> lapp.error(<span class="string">"missing required parameter: "</span>..parm) <span class="keyword">end</span>
            set_result(ps,parm,ps.defval)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> results
<span class="keyword">end</span>

<span class="keyword">if</span> arg <span class="keyword">then</span>
    script = arg[<span class="number">0</span>]
    script = script <span class="keyword">or</span> <span class="global">rawget</span>(_G,<span class="string">"LAPP_SCRIPT"</span>) <span class="keyword">or</span> <span class="string">"unknown"</span>
    <span class="comment">-- strip dir and extension to get current script name
</span>    script = script:gsub(<span class="string">'.+[\\/]'</span>,<span class="string">''</span>):gsub(<span class="string">'%.%a+$'</span>,<span class="string">''</span>)
<span class="keyword">else</span>
    script = <span class="string">"inter"</span>
<span class="keyword">end</span>


<span class="global">setmetatable</span>(lapp, {
    __call = <span class="keyword">function</span>(tbl,str,args) <span class="keyword">return</span> lapp.process_options_string(str,args) <span class="keyword">end</span>,
})


<span class="keyword">return</span> lapp</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2014-11-01 18:36:39 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
