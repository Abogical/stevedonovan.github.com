<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Penlight Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Penlight</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../source/app.lua.html">app.lua</a></li>
  <li><a href="../source/array2d.lua.html">array2d.lua</a></li>
  <li><a href="../source/class.lua.html">class.lua</a></li>
  <li><a href="../source/compat.lua.html">compat.lua</a></li>
  <li><a href="../source/comprehension.lua.html">comprehension.lua</a></li>
  <li><a href="../source/config.lua.html">config.lua</a></li>
  <li><a href="../source/data.lua.html">data.lua</a></li>
  <li><a href="../source/date.lua.html">date.lua</a></li>
  <li><a href="../source/dir.lua.html">dir.lua</a></li>
  <li><a href="../source/file.lua.html">file.lua</a></li>
  <li><a href="../source/func.lua.html">func.lua</a></li>
  <li><a href="../source/import_into.lua.html">import_into.lua</a></li>
  <li><a href="../source/init.lua.html">init.lua</a></li>
  <li><a href="../source/input.lua.html">input.lua</a></li>
  <li><a href="../source/lapp.lua.html">lapp.lua</a></li>
  <li><a href="../source/lexer.lua.html">lexer.lua</a></li>
  <li><a href="../source/list.lua.html">list.lua</a></li>
  <li><a href="../source/luabalanced.lua.html">luabalanced.lua</a></li>
  <li><a href="../source/map.lua.html">map.lua</a></li>
  <li><a href="../source/multimap.lua.html">multimap.lua</a></li>
  <li><a href="../source/operator.lua.html">operator.lua</a></li>
  <li><a href="../source/orderedmap.lua.html">orderedmap.lua</a></li>
  <li><a href="../source/path.lua.html">path.lua</a></li>
  <li><a href="../source/permute.lua.html">permute.lua</a></li>
  <li><a href="../source/pretty.lua.html">pretty.lua</a></li>
  <li><a href="../source/seesubst.lua.html">seesubst.lua</a></li>
  <li><strong>seq.lua</strong></li>
  <li><a href="../source/set.lua.html">set.lua</a></li>
  <li><a href="../source/sip.lua.html">sip.lua</a></li>
  <li><a href="../source/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../source/strict.lua.html">strict.lua</a></li>
  <li><a href="../source/stringio.lua.html">stringio.lua</a></li>
  <li><a href="../source/stringx.lua.html">stringx.lua</a></li>
  <li><a href="../source/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../source/tablex.lua.html">tablex.lua</a></li>
  <li><a href="../source/template.lua.html">template.lua</a></li>
  <li><a href="../source/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../source/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../source/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../source/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../source/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../source/test.lua.html">test.lua</a></li>
  <li><a href="../source/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../source/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../source/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../source/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../source/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../source/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../source/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../source/text.lua.html">text.lua</a></li>
  <li><a href="../source/types.lua.html">types.lua</a></li>
  <li><a href="../source/url.lua.html">url.lua</a></li>
  <li><a href="../source/utils.lua.html">utils.lua</a></li>
  <li><a href="../source/which.lua.html">which.lua</a></li>
  <li><a href="../source/xml.lua.html">xml.lua</a></li>
</ul>
<h2>Libraries</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../libraries/pl.html">pl</a></li>
  <li><a href="../libraries/pl.app.html">pl.app</a></li>
  <li><a href="../libraries/pl.array2d.html">pl.array2d</a></li>
  <li><a href="../libraries/pl.class.html">pl.class</a></li>
  <li><a href="../libraries/pl.compat.html">pl.compat</a></li>
  <li><a href="../libraries/pl.comprehension.html">pl.comprehension</a></li>
  <li><a href="../libraries/pl.config.html">pl.config</a></li>
  <li><a href="../libraries/pl.data.html">pl.data</a></li>
  <li><a href="../libraries/pl.dir.html">pl.dir</a></li>
  <li><a href="../libraries/pl.file.html">pl.file</a></li>
  <li><a href="../libraries/pl.func.html">pl.func</a></li>
  <li><a href="../libraries/pl.import_into.html">pl.import_into</a></li>
  <li><a href="../libraries/pl.input.html">pl.input</a></li>
  <li><a href="../libraries/pl.lapp.html">pl.lapp</a></li>
  <li><a href="../libraries/pl.lexer.html">pl.lexer</a></li>
  <li><a href="../libraries/pl.luabalanced.html">pl.luabalanced</a></li>
  <li><a href="../libraries/pl.operator.html">pl.operator</a></li>
  <li><a href="../libraries/pl.path.html">pl.path</a></li>
  <li><a href="../libraries/pl.permute.html">pl.permute</a></li>
  <li><a href="../libraries/pl.pretty.html">pl.pretty</a></li>
  <li><a href="../libraries/pl.seq.html">pl.seq</a></li>
  <li><a href="../libraries/pl.sip.html">pl.sip</a></li>
  <li><a href="../libraries/pl.strict.html">pl.strict</a></li>
  <li><a href="../libraries/pl.stringio.html">pl.stringio</a></li>
  <li><a href="../libraries/pl.stringx.html">pl.stringx</a></li>
  <li><a href="../libraries/pl.tablex.html">pl.tablex</a></li>
  <li><a href="../libraries/pl.template.html">pl.template</a></li>
  <li><a href="../libraries/pl.test.html">pl.test</a></li>
  <li><a href="../libraries/pl.text.html">pl.text</a></li>
  <li><a href="../libraries/pl.types.html">pl.types</a></li>
  <li><a href="../libraries/pl.url.html">pl.url</a></li>
  <li><a href="../libraries/pl.utils.html">pl.utils</a></li>
  <li><a href="../libraries/pl.xml.html">pl.xml</a></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/pl.Date.html">pl.Date</a></li>
  <li><a href="../classes/pl.List.html">pl.List</a></li>
  <li><a href="../classes/pl.Map.html">pl.Map</a></li>
  <li><a href="../classes/pl.MultiMap.html">pl.MultiMap</a></li>
  <li><a href="../classes/pl.OrderedMap.html">pl.OrderedMap</a></li>
  <li><a href="../classes/pl.Set.html">pl.Set</a></li>
</ul>
<h2>Manual</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../manual/01-introduction.md.html">Introduction</a></li>
  <li><a href="../manual/02-arrays.md.html">Tables and Arrays</a></li>
  <li><a href="../manual/03-strings.md.html">Strings. Higher-level operations on strings.</a></li>
  <li><a href="../manual/04-paths.md.html">Paths and Directories</a></li>
  <li><a href="../manual/05-dates.md.html">Date and Time</a></li>
  <li><a href="../manual/06-data.md.html">Data</a></li>
  <li><a href="../manual/07-functional.md.html">Functional Programming</a></li>
  <li><a href="../manual/08-additional.md.html">Additional Libraries</a></li>
  <li><a href="../manual/09-discussion.md.html">Technical Choices</a></li>
</ul>
<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../examples/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../examples/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../examples/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../examples/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../examples/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../examples/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../examples/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../examples/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../examples/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../examples/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../examples/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../examples/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../examples/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../examples/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../examples/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../examples/which.lua.html">which.lua</a></li>
</ul>

</div>

<div id="content">

    <h2>seq.lua</h2>
<pre>
<span class="comment">--- Manipulating iterators as sequences.
</span><span class="comment">-- See <a href="../manual/07-functional.md.html#Sequences">The Guide</a>
</span><span class="comment">--
</span><span class="comment">-- Dependencies: <a href="../libraries/pl.utils.html#">pl.utils</a>, <a href="../libraries/pl.types.html#">pl.types</a>, <a href="http://www.lua.org/manual/5.1/manual.html#5.9">debug</a>
</span><span class="comment">-- @module pl.seq
</span>
<span class="keyword">local</span> <span class="global">next</span>,<span class="global">assert</span>,<span class="global">type</span>,<span class="global">pairs</span>,<span class="global">tonumber</span>,<span class="global">type</span>,<span class="global">setmetatable</span>,<span class="global">getmetatable</span>,_G = <span class="global">next</span>,<span class="global">assert</span>,<span class="global">type</span>,<span class="global">pairs</span>,<span class="global">tonumber</span>,<span class="global">type</span>,<span class="global">setmetatable</span>,<span class="global">getmetatable</span>,_G
<span class="keyword">local</span> strfind,strmatch,format = <span class="global">string</span>.find,<span class="global">string</span>.match,<span class="global">string</span>.format
<span class="keyword">local</span> mrandom = <span class="global">math</span>.random
<span class="keyword">local</span> remove,tsort,tappend = <span class="global">table</span>.remove,<span class="global">table</span>.sort,<span class="global">table</span>.insert
<span class="keyword">local</span> <span class="global">io</span> = <span class="global">io</span>
<span class="keyword">local</span> utils = <span class="global">require</span> <span class="string">'pl.utils'</span>
<span class="keyword">local</span> callable = <span class="global">require</span> <span class="string">'pl.types'</span>.is_callable
<span class="keyword">local</span> function_arg = utils.function_arg
<span class="keyword">local</span> _List = utils.stdmt.List
<span class="keyword">local</span> _Map = utils.stdmt.Map
<span class="keyword">local</span> assert_arg = utils.assert_arg
<span class="keyword">local</span> <span class="global">debug</span> = <span class="global">require</span> <span class="string">'debug'</span>

<span class="keyword">local</span> seq = {}

<span class="comment">-- given a number, return a function(y) which returns true if y &gt; x
</span><span class="comment">-- @param x a number
</span><span class="keyword">function</span> seq.greater_than(x)
  <span class="keyword">return</span> <span class="keyword">function</span>(v)
    <span class="keyword">return</span> <span class="global">tonumber</span>(v) &gt; x
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- given a number, returns a function(y) which returns true if y &lt; x
</span><span class="comment">-- @param x a number
</span><span class="keyword">function</span> seq.less_than(x)
  <span class="keyword">return</span> <span class="keyword">function</span>(v)
    <span class="keyword">return</span> <span class="global">tonumber</span>(v) &lt; x
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- given any value, return a function(y) which returns true if y == x
</span><span class="comment">-- @param x a value
</span><span class="keyword">function</span> seq.equal_to(x)
  <span class="keyword">if</span> <span class="global">type</span>(x) == <span class="string">"number"</span> <span class="keyword">then</span>
    <span class="keyword">return</span> <span class="keyword">function</span>(v)
      <span class="keyword">return</span> <span class="global">tonumber</span>(v) == x
    <span class="keyword">end</span>
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">function</span>(v)
      <span class="keyword">return</span> v == x
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- given a string, return a function(y) which matches y against the string.
</span><a id="54"></a><span class="comment">-- @param s a string
</span><span class="keyword">function</span> seq.matching(s)
  <span class="keyword">return</span> <span class="keyword">function</span>(v)
     <span class="keyword">return</span> strfind(v,s)
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> nexti

<span class="comment">--- sequence adaptor for a table.   Note that if any generic function is
</span><span class="comment">-- passed a table, it will automatically use seq.list()
</span><span class="comment">-- @param t a list-like table
</span><span class="comment">-- @usage sum(list(t)) is the sum of all elements of t
</span><a id="67"></a><span class="comment">-- @usage for x in list(t) do...end
</span><span class="keyword">function</span> seq.list(t)
  assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
  <span class="keyword">if</span> <span class="keyword">not</span> nexti <span class="keyword">then</span>
    nexti = <span class="global">ipairs</span>{}
  <span class="keyword">end</span>
  <span class="keyword">local</span> key,value = <span class="number">0</span>
  <span class="keyword">return</span> <span class="keyword">function</span>()
    key,value = nexti(t,key)
    <span class="keyword">return</span> value
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- return the keys of the table.
</span><span class="comment">-- @param t an arbitrary table
</span><a id="82"></a><span class="comment">-- @return iterator over keys
</span><span class="keyword">function</span> seq.keys(t)
  assert_arg(<span class="number">1</span>,t,<span class="string">'table'</span>)
  <span class="keyword">local</span> key,value
  <span class="keyword">return</span> <span class="keyword">function</span>()
    key,value = <span class="global">next</span>(t,key)
    <span class="keyword">return</span> key
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> list = seq.list
<span class="keyword">local</span> <span class="keyword">function</span> default_iter(iter)
  <span class="keyword">if</span> <span class="global">type</span>(iter) == <span class="string">'table'</span> <span class="keyword">then</span> <span class="keyword">return</span> list(iter)
  <span class="keyword">else</span> <span class="keyword">return</span> iter <span class="keyword">end</span>
<span class="keyword">end</span>

seq.iter = default_iter

<span class="comment">--- create an iterator over a numerical range. Like the standard Python function xrange.
</span><span class="comment">-- @param start a number
</span><a id="102"></a><span class="comment">-- @param finish a number greater than start
</span><span class="keyword">function</span> seq.range(start,finish)
  <span class="keyword">local</span> i = start - <span class="number">1</span>
  <span class="keyword">return</span> <span class="keyword">function</span>()
      i = i + <span class="number">1</span>
      <span class="keyword">if</span> i &gt; finish <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span>
      <span class="keyword">else</span> <span class="keyword">return</span> i <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- count the number of elements in the sequence which satisfy the predicate
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @param condn a predicate function (must return either true or false)
</span><span class="comment">-- @param optional argument to be passed to predicate as second argument.
</span><span class="comment">-- @return count
</span><span class="keyword">function</span> seq.count(iter,condn,arg)
  <span class="keyword">local</span> i = <span class="number">0</span>
  seq.foreach(iter,<span class="keyword">function</span>(val)
        <span class="keyword">if</span> condn(val,arg) <span class="keyword">then</span> i = i + <span class="number">1</span> <span class="keyword">end</span>
  <span class="keyword">end</span>)
  <span class="keyword">return</span> i
<span class="keyword">end</span>

<span class="comment">--- return the minimum and the maximum value of the sequence.
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @return minimum value
</span><a id="128"></a><span class="comment">-- @return maximum value
</span><span class="keyword">function</span> seq.minmax(iter)
  <span class="keyword">local</span> vmin,vmax = <span class="number">1e70</span>,-<span class="number">1e70</span>
  <span class="keyword">for</span> v <span class="keyword">in</span> default_iter(iter) <span class="keyword">do</span>
    v = <span class="global">tonumber</span>(v)
    <span class="keyword">if</span> v &lt; vmin <span class="keyword">then</span> vmin = v <span class="keyword">end</span>
    <span class="keyword">if</span> v &gt; vmax <span class="keyword">then</span> vmax = v <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">return</span> vmin,vmax
<span class="keyword">end</span>

<span class="comment">--- return the sum and element count of the sequence.
</span><span class="comment">-- @param iter a sequence
</span><a id="141"></a><span class="comment">-- @param fn an optional function to apply to the values
</span><span class="keyword">function</span> seq.sum(iter,fn)
  <span class="keyword">local</span> s = <span class="number">0</span>
  <span class="keyword">local</span> i = <span class="number">0</span>
  <span class="keyword">for</span> v <span class="keyword">in</span> default_iter(iter) <span class="keyword">do</span>
    <span class="keyword">if</span> fn <span class="keyword">then</span> v = fn(v) <span class="keyword">end</span>
    s = s + v
    i = i + <span class="number">1</span>
  <span class="keyword">end</span>
  <span class="keyword">return</span> s,i
<span class="keyword">end</span>

<span class="comment">--- create a table from the sequence. (This will make the result a List.)
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @return a List
</span><span class="comment">-- @usage copy(list(ls)) is equal to ls
</span><a id="157"></a><span class="comment">-- @usage copy(list {1,2,3}) == List{1,2,3}
</span><span class="keyword">function</span> seq.copy(iter)
    <span class="keyword">local</span> res,k = {},<span class="number">1</span>
    <span class="keyword">for</span> v <span class="keyword">in</span> default_iter(iter) <span class="keyword">do</span>
        res[k] = v
        k = k + <span class="number">1</span>
    <span class="keyword">end</span>
    <span class="global">setmetatable</span>(res,_List)
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="comment">--- create a table of pairs from the double-valued sequence.
</span><span class="comment">-- @param iter a double-valued sequence
</span><span class="comment">-- @param i1 used to capture extra iterator values
</span><span class="comment">-- @param i2 as with pairs &amp; ipairs
</span><span class="comment">-- @usage copy2(ipairs{10,20,30}) == {{1,10},{2,20},{3,30}}
</span><a id="173"></a><span class="comment">-- @return a list-like table
</span><span class="keyword">function</span> seq.copy2 (iter,i1,i2)
    <span class="keyword">local</span> res,k = {},<span class="number">1</span>
    <span class="keyword">for</span> v1,v2 <span class="keyword">in</span> iter,i1,i2 <span class="keyword">do</span>
        res[k] = {v1,v2}
        k = k + <span class="number">1</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="comment">--- create a table of 'tuples' from a multi-valued sequence.
</span><span class="comment">-- A generalization of copy2 above
</span><span class="comment">-- @param iter a multiple-valued sequence
</span><a id="186"></a><span class="comment">-- @return a list-like table
</span><span class="keyword">function</span> seq.copy_tuples (iter)
    iter = default_iter(iter)
    <span class="keyword">local</span> res = {}
    <span class="keyword">local</span> row = {iter()}
    <span class="keyword">while</span> #row &gt; <span class="number">0</span> <span class="keyword">do</span>
        tappend(res,row)
        row = {iter()}
    <span class="keyword">end</span>
    <span class="keyword">return</span> res
<span class="keyword">end</span>

<span class="comment">--- return an iterator of random numbers.
</span><span class="comment">-- @param n the length of the sequence
</span><span class="comment">-- @param l same as the first optional argument to math.random
</span><span class="comment">-- @param u same as the second optional argument to math.random
</span><a id="202"></a><span class="comment">-- @return a sequnce
</span><span class="keyword">function</span> seq.random(n,l,u)
  <span class="keyword">local</span> rand
  <span class="global">assert</span>(<span class="global">type</span>(n) == <span class="string">'number'</span>)
  <span class="keyword">if</span> u <span class="keyword">then</span>
     rand = <span class="keyword">function</span>() <span class="keyword">return</span> mrandom(l,u) <span class="keyword">end</span>
  <span class="keyword">elseif</span> l <span class="keyword">then</span>
     rand = <span class="keyword">function</span>() <span class="keyword">return</span> mrandom(l) <span class="keyword">end</span>
  <span class="keyword">else</span>
     rand = mrandom
  <span class="keyword">end</span>

  <span class="keyword">return</span> <span class="keyword">function</span>()
     <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span>
     <span class="keyword">else</span>
       n = n - <span class="number">1</span>
       <span class="keyword">return</span> rand()
     <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- return an iterator to the sorted elements of a sequence.
</span><span class="comment">-- @param iter a sequence
</span><a id="225"></a><span class="comment">-- @param comp an optional comparison function (comp(x,y) is true if x &lt; y)
</span><span class="keyword">function</span> seq.sort(iter,comp)
    <span class="keyword">local</span> t = seq.copy(iter)
    tsort(t,comp)
    <span class="keyword">return</span> list(t)
<span class="keyword">end</span>

<span class="comment">--- return an iterator which returns elements of two sequences.
</span><span class="comment">-- @param iter1 a sequence
</span><span class="comment">-- @param iter2 a sequence
</span><a id="235"></a><span class="comment">-- @usage for x,y in seq.zip(ls1,ls2) do....end
</span><span class="keyword">function</span> seq.zip(iter1,iter2)
    iter1 = default_iter(iter1)
    iter2 = default_iter(iter2)
    <span class="keyword">return</span> <span class="keyword">function</span>()
        <span class="keyword">return</span> iter1(),iter2()
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- Makes a table where the key/values are the values and value counts of the sequence.
</span><span class="comment">-- This version works with 'hashable' values like strings and numbers.
</span><span class="comment">-- <a href="../libraries/pl.tablex.html#count_map">pl.tablex.count_map</a> is more general.
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @return a map-like table
</span><span class="comment">-- @return a table
</span><a id="250"></a><span class="comment">-- @see pl.tablex.count_map
</span><span class="keyword">function</span> seq.count_map(iter)
    <span class="keyword">local</span> t = {}
    <span class="keyword">local</span> v
    <span class="keyword">for</span> s <span class="keyword">in</span> default_iter(iter) <span class="keyword">do</span>
        v = t[s]
        <span class="keyword">if</span> v <span class="keyword">then</span> t[s] = v + <span class="number">1</span>
        <span class="keyword">else</span> t[s] = <span class="number">1</span> <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> <span class="global">setmetatable</span>(t,_Map)
<span class="keyword">end</span>

<span class="comment">-- given a sequence, return all the unique values in that sequence.
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @param returns_table true if we return a table, not a sequence
</span><span class="comment">-- @return a sequence or a table; defaults to a sequence.
</span><span class="keyword">function</span> seq.unique(iter,returns_table)
    <span class="keyword">local</span> t = seq.count_map(iter)
    <span class="keyword">local</span> res,k = {},<span class="number">1</span>
    <span class="keyword">for</span> key <span class="keyword">in</span> <span class="global">pairs</span>(t) <span class="keyword">do</span> res[k] = key; k = k + <span class="number">1</span> <span class="keyword">end</span>
    <span class="global">table</span>.sort(res)
    <span class="keyword">if</span> returns_table <span class="keyword">then</span>
        <span class="keyword">return</span> res
    <span class="keyword">else</span>
        <span class="keyword">return</span> list(res)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- print out a sequence iter with a separator.
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @param sep the separator (default space)
</span><span class="comment">-- @param nfields maximum number of values per line (default 7)
</span><a id="282"></a><span class="comment">-- @param fmt optional format function for each value
</span><span class="keyword">function</span> seq.printall(iter,sep,nfields,fmt)
  <span class="keyword">local</span> write = <span class="global">io</span>.write
  <span class="keyword">if</span> <span class="keyword">not</span> sep <span class="keyword">then</span> sep = <span class="string">' '</span> <span class="keyword">end</span>
  <span class="keyword">if</span> <span class="keyword">not</span> nfields <span class="keyword">then</span>
      <span class="keyword">if</span> sep == <span class="string">'\n'</span> <span class="keyword">then</span> nfields = <span class="number">1e30</span>
      <span class="keyword">else</span> nfields = <span class="number">7</span> <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">if</span> fmt <span class="keyword">then</span>
    <span class="keyword">local</span> fstr = fmt
    fmt = <span class="keyword">function</span>(v) <span class="keyword">return</span> format(fstr,v) <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">local</span> k = <span class="number">1</span>
  <span class="keyword">for</span> v <span class="keyword">in</span> default_iter(iter) <span class="keyword">do</span>
     <span class="keyword">if</span> fmt <span class="keyword">then</span> v = fmt(v) <span class="keyword">end</span>
     <span class="keyword">if</span> k &lt; nfields <span class="keyword">then</span>
       write(v,sep)
       k = k + <span class="number">1</span>
    <span class="keyword">else</span>
       write(v,<span class="string">'\n'</span>)
       k = <span class="number">1</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  write <span class="string">'\n'</span>
<span class="keyword">end</span>

<span class="comment">-- return an iterator running over every element of two sequences (concatenation).
</span><span class="comment">-- @param iter1 a sequence
</span><span class="comment">-- @param iter2 a sequence
</span><span class="keyword">function</span> seq.splice(iter1,iter2)
  iter1 = default_iter(iter1)
  iter2 = default_iter(iter2)
  <span class="keyword">local</span> iter = iter1
  <span class="keyword">return</span> <span class="keyword">function</span>()
    <span class="keyword">local</span> ret = iter()
    <span class="keyword">if</span> ret == <span class="keyword">nil</span> <span class="keyword">then</span>
      <span class="keyword">if</span> iter == iter1 <span class="keyword">then</span>
        iter = iter2
        <span class="keyword">return</span> iter()
      <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
   <span class="keyword">else</span>
       <span class="keyword">return</span>  ret
   <span class="keyword">end</span>
 <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- return a sequence where every element of a sequence has been transformed
</span><span class="comment">-- by a function. If you don't supply an argument, then the function will
</span><span class="comment">-- receive both values of a double-valued sequence, otherwise behaves rather like
</span><span class="comment">-- tablex.map.
</span><span class="comment">-- @param fn a function to apply to elements; may take two arguments
</span><span class="comment">-- @param iter a sequence of one or two values
</span><a id="334"></a><span class="comment">-- @param arg optional argument to pass to function.
</span><span class="keyword">function</span> seq.map(fn,iter,arg)
    fn = function_arg(<span class="number">1</span>,fn)
    iter = default_iter(iter)
    <span class="keyword">return</span> <span class="keyword">function</span>()
        <span class="keyword">local</span> v1,v2 = iter()
        <span class="keyword">if</span> v1 == <span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
        <span class="keyword">if</span> arg <span class="keyword">then</span> <span class="keyword">return</span> fn(v1,arg) <span class="keyword">or</span> <span class="keyword">false</span>
        <span class="keyword">else</span> <span class="keyword">return</span> fn(v1,v2) <span class="keyword">or</span> <span class="keyword">false</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- filter a sequence using a predicate function.
</span><span class="comment">-- @param iter a sequence of one or two values
</span><span class="comment">-- @param pred a boolean function; may take two arguments
</span><a id="350"></a><span class="comment">-- @param arg optional argument to pass to function.
</span><span class="keyword">function</span> seq.filter (iter,pred,arg)
    pred = function_arg(<span class="number">2</span>,pred)
    <span class="keyword">return</span> <span class="keyword">function</span> ()
        <span class="keyword">local</span> v1,v2
        <span class="keyword">while</span> <span class="keyword">true</span> <span class="keyword">do</span>
            v1,v2 = iter()
            <span class="keyword">if</span> v1 == <span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
            <span class="keyword">if</span> arg <span class="keyword">then</span>
                <span class="keyword">if</span> pred(v1,arg) <span class="keyword">then</span> <span class="keyword">return</span> v1,v2 <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> pred(v1,v2) <span class="keyword">then</span> <span class="keyword">return</span> v1,v2 <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- 'reduce' a sequence using a binary function.
</span><span class="comment">-- @func fun a function of two arguments
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @param oldval optional initial value
</span><span class="comment">-- @usage seq.reduce(operator.add,seq.list{1,2,3,4}) == 10
</span><a id="372"></a><span class="comment">-- @usage seq.reduce('-',{1,2,3,4,5}) == -13
</span><span class="keyword">function</span> seq.reduce (fun,iter,oldval)
   fun = function_arg(<span class="number">1</span>,fun)
   iter = default_iter(iter)
   <span class="keyword">if</span> <span class="keyword">not</span> oldval <span class="keyword">then</span>
       oldval = iter()
   <span class="keyword">end</span>
   <span class="keyword">local</span> val = oldval
   <span class="keyword">for</span> v <span class="keyword">in</span> iter <span class="keyword">do</span>
       val = fun(val,v)
   <span class="keyword">end</span>
   <span class="keyword">return</span> val
<span class="keyword">end</span>

<span class="comment">--- take the first n values from the sequence.
</span><span class="comment">-- @param iter a sequence of one or two values
</span><span class="comment">-- @param n number of items to take
</span><a id="389"></a><span class="comment">-- @return a sequence of at most n items
</span><span class="keyword">function</span> seq.take (iter,n)
    <span class="keyword">local</span> i = <span class="number">1</span>
    iter = default_iter(iter)
    <span class="keyword">return</span> <span class="keyword">function</span>()
        <span class="keyword">if</span> i &gt; n <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span>
        <span class="keyword">local</span> val1,val2 = iter()
        <span class="keyword">if</span> <span class="keyword">not</span> val1 <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span>
        i = i + <span class="number">1</span>
        <span class="keyword">return</span> val1,val2
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- skip the first n values of a sequence
</span><span class="comment">-- @param iter a sequence of one or more values
</span><a id="404"></a><span class="comment">-- @param n number of items to skip
</span><span class="keyword">function</span> seq.skip (iter,n)
    n = n <span class="keyword">or</span> <span class="number">1</span>
    <span class="keyword">for</span> i = <span class="number">1</span>,n <span class="keyword">do</span> iter() <span class="keyword">end</span>
    <span class="keyword">return</span> iter
<span class="keyword">end</span>

<span class="comment">--- a sequence with a sequence count and the original value.
</span><span class="comment">-- enum(copy(ls)) is a roundabout way of saying ipairs(ls).
</span><span class="comment">-- @param iter a single or double valued sequence
</span><a id="414"></a><span class="comment">-- @return sequence of (i,v), i = 1..n and v is from iter.
</span><span class="keyword">function</span> seq.enum (iter)
    <span class="keyword">local</span> i = <span class="number">0</span>
    iter = default_iter(iter)
    <span class="keyword">return</span> <span class="keyword">function</span>  ()
        <span class="keyword">local</span> val1,val2 = iter()
        <span class="keyword">if</span> <span class="keyword">not</span> val1 <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span>
        i = i + <span class="number">1</span>
        <span class="keyword">return</span> i,val1,val2
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- map using a named method over a sequence.
</span><span class="comment">-- @param iter a sequence
</span><span class="comment">-- @param name the method name
</span><span class="comment">-- @param arg1 optional first extra argument
</span><a id="430"></a><span class="comment">-- @param arg2 optional second extra argument
</span><span class="keyword">function</span> seq.mapmethod (iter,name,arg1,arg2)
    iter = default_iter(iter)
    <span class="keyword">return</span> <span class="keyword">function</span>()
        <span class="keyword">local</span> val = iter()
        <span class="keyword">if</span> <span class="keyword">not</span> val <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span>
        <span class="keyword">local</span> fn = val[name]
        <span class="keyword">if</span> <span class="keyword">not</span> fn <span class="keyword">then</span> error(<span class="global">type</span>(val)..<span class="string">" does not have method "</span>..name) <span class="keyword">end</span>
        <span class="keyword">return</span> fn(val,arg1,arg2)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- a sequence of (last,current) values from another sequence.
</span><span class="comment">--  This will return S(i-1),S(i) if given S(i)
</span><a id="444"></a><span class="comment">-- @param iter a sequence
</span><span class="keyword">function</span> seq.last (iter)
    iter = default_iter(iter)
    <span class="keyword">local</span> l = iter()
    <span class="keyword">if</span> l == <span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
    <span class="keyword">return</span> <span class="keyword">function</span> ()
        <span class="keyword">local</span> val,ll
        val = iter()
        <span class="keyword">if</span> val == <span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">nil</span> <span class="keyword">end</span>
        ll = l
        l = val
        <span class="keyword">return</span> val,ll
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- call the function on each element of the sequence.
</span><span class="comment">-- @param iter a sequence with up to 3 values
</span><a id="461"></a><span class="comment">-- @param fn a function
</span><span class="keyword">function</span> seq.foreach(iter,fn)
    fn = function_arg(<span class="number">2</span>,fn)
    <span class="keyword">for</span> i1,i2,i3 <span class="keyword">in</span> default_iter(iter) <span class="keyword">do</span> fn(i1,i2,i3) <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">---------------------- Sequence Adapters ---------------------
</span>
<span class="keyword">local</span> SMT

<span class="keyword">local</span> <span class="keyword">function</span> SW (iter,...)
    <span class="keyword">if</span> callable(iter) <span class="keyword">then</span>
        <span class="keyword">return</span> <span class="global">setmetatable</span>({iter=iter},SMT)
    <span class="keyword">else</span>
        <span class="keyword">return</span> iter,...
    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="comment">-- can't directly look these up in seq because of the wrong argument order...
</span><span class="keyword">local</span> map,reduce,mapmethod = seq.map, seq.reduce, seq.mapmethod
<span class="keyword">local</span> overrides = {
    map = <span class="keyword">function</span>(self,fun,arg)
        <span class="keyword">return</span> map(fun,self,arg)
    <span class="keyword">end</span>,
    reduce = <span class="keyword">function</span>(self,fun)
        <span class="keyword">return</span> reduce(fun,self)
    <span class="keyword">end</span>
}

SMT = {
    __index = <span class="keyword">function</span> (tbl,key)
        <span class="keyword">local</span> fn = overrides[key] <span class="keyword">or</span> seq[key]
        <span class="keyword">if</span> fn <span class="keyword">then</span>
            <span class="keyword">return</span> <span class="keyword">function</span>(sw,...) <span class="keyword">return</span> SW(fn(sw.iter,...)) <span class="keyword">end</span>
        <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="keyword">function</span>(sw,...) <span class="keyword">return</span> SW(mapmethod(sw.iter,key,...)) <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>,
    __call = <span class="keyword">function</span> (sw)
        <span class="keyword">return</span> sw.iter()
    <span class="keyword">end</span>,
}

<span class="global">setmetatable</span>(seq,{
    __call = <span class="keyword">function</span>(tbl,iter)
        <span class="keyword">if</span> <span class="keyword">not</span> callable(iter) <span class="keyword">then</span>
            <span class="keyword">if</span> <span class="global">type</span>(iter) == <span class="string">'table'</span> <span class="keyword">then</span> iter = seq.list(iter)
            <span class="keyword">else</span> <span class="keyword">return</span> iter
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">return</span> <span class="global">setmetatable</span>({iter=iter},SMT)
    <span class="keyword">end</span>
})

<span class="comment">--- create a wrapped iterator over all lines in the file.
</span><span class="comment">-- @param f either a filename, file-like object, or 'STDIN' (for standard input)
</span><span class="comment">-- @param ... for Lua 5.2 only, optional format specifiers, as in <a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.read">io.read</a>.
</span><a id="519"></a><span class="comment">-- @return a sequence wrapper
</span><span class="keyword">function</span> seq.lines (f,...)
    <span class="keyword">local</span> n = <span class="global">select</span>(<span class="string">'#'</span>,...)
    <span class="keyword">local</span> iter,obj
    <span class="keyword">if</span> f == <span class="string">'STDIN'</span> <span class="keyword">then</span>
        f = <span class="global">io</span>.stdin
    <span class="keyword">elseif</span> <span class="global">type</span>(f) == <span class="string">'string'</span> <span class="keyword">then</span>
        iter,obj = <span class="global">io</span>.lines(f,...)
    <span class="keyword">elseif</span> <span class="keyword">not</span> f.read <span class="keyword">then</span>
        error(<span class="string">"Pass either a string or a file-like object"</span>,<span class="number">2</span>)
    <span class="keyword">end</span>
    <span class="keyword">if</span> <span class="keyword">not</span> iter <span class="keyword">then</span>
        iter,obj = f:lines(...)
    <span class="keyword">end</span>
    <span class="keyword">if</span> obj <span class="keyword">then</span> <span class="comment">-- LuaJIT version returns a function operating on a file
</span>        <span class="keyword">local</span> lines,file = iter,obj
        iter = <span class="keyword">function</span>() <span class="keyword">return</span> lines(file) <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> SW(iter)
<span class="keyword">end</span>

<span class="keyword">function</span> seq.import ()
    _G.<span class="global">debug</span>.<span class="global">setmetatable</span>(<span class="keyword">function</span>() <span class="keyword">end</span>,{
        __index = <span class="keyword">function</span>(tbl,key)
            <span class="keyword">local</span> s = overrides[key] <span class="keyword">or</span> seq[key]
            <span class="keyword">if</span> s <span class="keyword">then</span> <span class="keyword">return</span> s
            <span class="keyword">else</span>
                <span class="keyword">return</span> <span class="keyword">function</span>(s,...) <span class="keyword">return</span> seq.mapmethod(s,key,...) <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    })
<span class="keyword">end</span>

<span class="keyword">return</span> seq</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2014-11-01 18:36:39 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
