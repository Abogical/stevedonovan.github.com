<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Penlight Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Penlight</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><strong>app.lua</strong></li>
  <li><a href="../source/array2d.lua.html">array2d.lua</a></li>
  <li><a href="../source/class.lua.html">class.lua</a></li>
  <li><a href="../source/compat.lua.html">compat.lua</a></li>
  <li><a href="../source/comprehension.lua.html">comprehension.lua</a></li>
  <li><a href="../source/config.lua.html">config.lua</a></li>
  <li><a href="../source/data.lua.html">data.lua</a></li>
  <li><a href="../source/date.lua.html">date.lua</a></li>
  <li><a href="../source/dir.lua.html">dir.lua</a></li>
  <li><a href="../source/file.lua.html">file.lua</a></li>
  <li><a href="../source/func.lua.html">func.lua</a></li>
  <li><a href="../source/import_into.lua.html">import_into.lua</a></li>
  <li><a href="../source/init.lua.html">init.lua</a></li>
  <li><a href="../source/input.lua.html">input.lua</a></li>
  <li><a href="../source/lapp.lua.html">lapp.lua</a></li>
  <li><a href="../source/lexer.lua.html">lexer.lua</a></li>
  <li><a href="../source/list.lua.html">list.lua</a></li>
  <li><a href="../source/luabalanced.lua.html">luabalanced.lua</a></li>
  <li><a href="../source/map.lua.html">map.lua</a></li>
  <li><a href="../source/multimap.lua.html">multimap.lua</a></li>
  <li><a href="../source/operator.lua.html">operator.lua</a></li>
  <li><a href="../source/orderedmap.lua.html">orderedmap.lua</a></li>
  <li><a href="../source/path.lua.html">path.lua</a></li>
  <li><a href="../source/permute.lua.html">permute.lua</a></li>
  <li><a href="../source/pretty.lua.html">pretty.lua</a></li>
  <li><a href="../source/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../source/seq.lua.html">seq.lua</a></li>
  <li><a href="../source/set.lua.html">set.lua</a></li>
  <li><a href="../source/sip.lua.html">sip.lua</a></li>
  <li><a href="../source/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../source/strict.lua.html">strict.lua</a></li>
  <li><a href="../source/stringio.lua.html">stringio.lua</a></li>
  <li><a href="../source/stringx.lua.html">stringx.lua</a></li>
  <li><a href="../source/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../source/tablex.lua.html">tablex.lua</a></li>
  <li><a href="../source/template.lua.html">template.lua</a></li>
  <li><a href="../source/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../source/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../source/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../source/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../source/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../source/test.lua.html">test.lua</a></li>
  <li><a href="../source/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../source/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../source/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../source/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../source/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../source/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../source/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../source/text.lua.html">text.lua</a></li>
  <li><a href="../source/types.lua.html">types.lua</a></li>
  <li><a href="../source/url.lua.html">url.lua</a></li>
  <li><a href="../source/utils.lua.html">utils.lua</a></li>
  <li><a href="../source/which.lua.html">which.lua</a></li>
  <li><a href="../source/xml.lua.html">xml.lua</a></li>
</ul>
<h2>Libraries</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../libraries/pl.html">pl</a></li>
  <li><a href="../libraries/pl.app.html">pl.app</a></li>
  <li><a href="../libraries/pl.array2d.html">pl.array2d</a></li>
  <li><a href="../libraries/pl.class.html">pl.class</a></li>
  <li><a href="../libraries/pl.compat.html">pl.compat</a></li>
  <li><a href="../libraries/pl.comprehension.html">pl.comprehension</a></li>
  <li><a href="../libraries/pl.config.html">pl.config</a></li>
  <li><a href="../libraries/pl.data.html">pl.data</a></li>
  <li><a href="../libraries/pl.dir.html">pl.dir</a></li>
  <li><a href="../libraries/pl.file.html">pl.file</a></li>
  <li><a href="../libraries/pl.func.html">pl.func</a></li>
  <li><a href="../libraries/pl.import_into.html">pl.import_into</a></li>
  <li><a href="../libraries/pl.input.html">pl.input</a></li>
  <li><a href="../libraries/pl.lapp.html">pl.lapp</a></li>
  <li><a href="../libraries/pl.lexer.html">pl.lexer</a></li>
  <li><a href="../libraries/pl.luabalanced.html">pl.luabalanced</a></li>
  <li><a href="../libraries/pl.operator.html">pl.operator</a></li>
  <li><a href="../libraries/pl.path.html">pl.path</a></li>
  <li><a href="../libraries/pl.permute.html">pl.permute</a></li>
  <li><a href="../libraries/pl.pretty.html">pl.pretty</a></li>
  <li><a href="../libraries/pl.seq.html">pl.seq</a></li>
  <li><a href="../libraries/pl.sip.html">pl.sip</a></li>
  <li><a href="../libraries/pl.strict.html">pl.strict</a></li>
  <li><a href="../libraries/pl.stringio.html">pl.stringio</a></li>
  <li><a href="../libraries/pl.stringx.html">pl.stringx</a></li>
  <li><a href="../libraries/pl.tablex.html">pl.tablex</a></li>
  <li><a href="../libraries/pl.template.html">pl.template</a></li>
  <li><a href="../libraries/pl.test.html">pl.test</a></li>
  <li><a href="../libraries/pl.text.html">pl.text</a></li>
  <li><a href="../libraries/pl.types.html">pl.types</a></li>
  <li><a href="../libraries/pl.url.html">pl.url</a></li>
  <li><a href="../libraries/pl.utils.html">pl.utils</a></li>
  <li><a href="../libraries/pl.xml.html">pl.xml</a></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/pl.Date.html">pl.Date</a></li>
  <li><a href="../classes/pl.List.html">pl.List</a></li>
  <li><a href="../classes/pl.Map.html">pl.Map</a></li>
  <li><a href="../classes/pl.MultiMap.html">pl.MultiMap</a></li>
  <li><a href="../classes/pl.OrderedMap.html">pl.OrderedMap</a></li>
  <li><a href="../classes/pl.Set.html">pl.Set</a></li>
</ul>
<h2>Manual</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../manual/01-introduction.md.html">Introduction</a></li>
  <li><a href="../manual/02-arrays.md.html">Tables and Arrays</a></li>
  <li><a href="../manual/03-strings.md.html">Strings. Higher-level operations on strings.</a></li>
  <li><a href="../manual/04-paths.md.html">Paths and Directories</a></li>
  <li><a href="../manual/05-dates.md.html">Date and Time</a></li>
  <li><a href="../manual/06-data.md.html">Data</a></li>
  <li><a href="../manual/07-functional.md.html">Functional Programming</a></li>
  <li><a href="../manual/08-additional.md.html">Additional Libraries</a></li>
  <li><a href="../manual/09-discussion.md.html">Technical Choices</a></li>
</ul>
<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../examples/seesubst.lua.html">seesubst.lua</a></li>
  <li><a href="../examples/sipscan.lua.html">sipscan.lua</a></li>
  <li><a href="../examples/symbols.lua.html">symbols.lua</a></li>
  <li><a href="../examples/test-cmp.lua.html">test-cmp.lua</a></li>
  <li><a href="../examples/test-data.lua.html">test-data.lua</a></li>
  <li><a href="../examples/test-listcallbacks.lua.html">test-listcallbacks.lua</a></li>
  <li><a href="../examples/test-pretty.lua.html">test-pretty.lua</a></li>
  <li><a href="../examples/test-symbols.lua.html">test-symbols.lua</a></li>
  <li><a href="../examples/testapp.lua.html">testapp.lua</a></li>
  <li><a href="../examples/testclone.lua.html">testclone.lua</a></li>
  <li><a href="../examples/testconfig.lua.html">testconfig.lua</a></li>
  <li><a href="../examples/testglobal.lua.html">testglobal.lua</a></li>
  <li><a href="../examples/testinputfields.lua.html">testinputfields.lua</a></li>
  <li><a href="../examples/testinputfields2.lua.html">testinputfields2.lua</a></li>
  <li><a href="../examples/testxml.lua.html">testxml.lua</a></li>
  <li><a href="../examples/which.lua.html">which.lua</a></li>
</ul>

</div>

<div id="content">

    <h2>app.lua</h2>
<pre>
<span class="comment">--- Application support functions.
</span><span class="comment">-- See <a href="../manual/01-introduction.md.html#Application_Support">the Guide</a>
</span><span class="comment">--
</span><span class="comment">-- Dependencies: <a href="../libraries/pl.utils.html#">pl.utils</a>, <a href="../libraries/pl.path.html#">pl.path</a>
</span><span class="comment">-- @module pl.app
</span>
<span class="keyword">local</span> <span class="global">io</span>,<span class="global">package</span>,<span class="global">require</span> = _G.<span class="global">io</span>, _G.<span class="global">package</span>, _G.<span class="global">require</span>
<span class="keyword">local</span> utils = <span class="global">require</span> <span class="string">'pl.utils'</span>
<span class="keyword">local</span> path = <span class="global">require</span> <span class="string">'pl.path'</span>

<span class="keyword">local</span> app = {}

<span class="keyword">local</span> <span class="keyword">function</span> check_script_name ()
    <span class="keyword">if</span> _G.arg == <span class="keyword">nil</span> <span class="keyword">then</span> error(<span class="string">'no command line args available\nWas this run from a main script?'</span>) <span class="keyword">end</span>
    <span class="keyword">return</span> _G.arg[<span class="number">0</span>]
<span class="keyword">end</span>

<span class="comment">--- add the current script's path to the Lua module path.
</span><span class="comment">-- Applies to both the source and the binary module paths. It makes it easy for
</span><span class="comment">-- the main file of a multi-file program to access its modules in the same directory.
</span><span class="comment">-- <code>base</code> allows these modules to be put in a specified subdirectory, to allow for
</span><span class="comment">-- cleaner deployment and resolve potential conflicts between a script name and its
</span><span class="comment">-- library directory.
</span><span class="comment">-- @string base optional base directory.
</span><a id="26"></a><span class="comment">-- @treturn string the current script's path with a trailing slash
</span><span class="keyword">function</span> app.require_here (base)
    <span class="keyword">local</span> p = path.dirname(check_script_name())
    <span class="keyword">if</span> <span class="keyword">not</span> path.isabs(p) <span class="keyword">then</span>
        p = path.join(path.currentdir(),p)
    <span class="keyword">end</span>
    <span class="keyword">if</span> p:sub(-<span class="number">1</span>,-<span class="number">1</span>) ~= path.sep <span class="keyword">then</span>
        p = p..path.sep
    <span class="keyword">end</span>
    <span class="keyword">if</span> base <span class="keyword">then</span>
        p = p..base..path.sep
    <span class="keyword">end</span>
    <span class="keyword">local</span> so_ext = path.is_windows <span class="keyword">and</span> <span class="string">'dll'</span> <span class="keyword">or</span> <span class="string">'so'</span>
    <span class="keyword">local</span> lsep = <span class="global">package</span>.path:find <span class="string">'^;'</span> <span class="keyword">and</span> <span class="string">''</span> <span class="keyword">or</span> <span class="string">';'</span>
    <span class="keyword">local</span> csep = <span class="global">package</span>.cpath:find <span class="string">'^;'</span> <span class="keyword">and</span> <span class="string">''</span> <span class="keyword">or</span> <span class="string">';'</span>
    <span class="global">package</span>.path = (<span class="string">'%s?.lua;%s?%sinit.lua%s%s'</span>):format(p,p,path.sep,lsep,<span class="global">package</span>.path)
    <span class="global">package</span>.cpath = (<span class="string">'%s?.%s%s%s'</span>):format(p,so_ext,csep,<span class="global">package</span>.cpath)
    <span class="keyword">return</span> p
<span class="keyword">end</span>

<span class="comment">--- return a suitable path for files private to this application.
</span><span class="comment">-- These will look like '~/.SNAME/file', with '~' as with expanduser and
</span><span class="comment">-- SNAME is the name of the script without .lua extension.
</span><span class="comment">-- @string file a filename (w/out path)
</span><span class="comment">-- @return a full pathname, or nil
</span><a id="51"></a><span class="comment">-- @return 'cannot create' error
</span><span class="keyword">function</span> app.appfile (file)
    <span class="keyword">local</span> sname = path.basename(check_script_name())
    <span class="keyword">local</span> name,ext = path.splitext(sname)
    <span class="keyword">local</span> dir = path.join(path.expanduser(<span class="string">'~'</span>),<span class="string">'.'</span>..name)
    <span class="keyword">if</span> <span class="keyword">not</span> path.isdir(dir) <span class="keyword">then</span>
        <span class="keyword">local</span> ret = path.mkdir(dir)
        <span class="keyword">if</span> <span class="keyword">not</span> ret <span class="keyword">then</span> <span class="keyword">return</span> utils.raise (<span class="string">'cannot create '</span>..dir) <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> path.join(dir,file)
<span class="keyword">end</span>

<span class="comment">--- return string indicating operating system.
</span><a id="64"></a><span class="comment">-- @return 'Windows','OSX' or whatever uname returns (e.g. 'Linux')
</span><span class="keyword">function</span> app.platform()
    <span class="keyword">if</span> path.is_windows <span class="keyword">then</span>
        <span class="keyword">return</span> <span class="string">'Windows'</span>
    <span class="keyword">else</span>
        <span class="keyword">local</span> f = <span class="global">io</span>.popen(<span class="string">'uname'</span>)
        <span class="keyword">local</span> res = f:read()
        <span class="keyword">if</span> res == <span class="string">'Darwin'</span> <span class="keyword">then</span> res = <span class="string">'OSX'</span> <span class="keyword">end</span>
        f:close()
        <span class="keyword">return</span> res
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- return the full command-line used to invoke this script.
</span><span class="comment">-- Any extra flags occupy slots, so that <code>lua -lpl</code> gives us <code>{[-2]=&apos;lua&apos;,[-1]=&apos;-lpl&apos;}</code>
</span><span class="comment">-- @return command-line
</span><a id="80"></a><span class="comment">-- @return name of Lua program used
</span><span class="keyword">function</span> app.lua ()
    <span class="keyword">local</span> args = _G.arg <span class="keyword">or</span> error <span class="string">"not in a main program"</span>
    <span class="keyword">local</span> imin = <span class="number">0</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="global">pairs</span>(args) <span class="keyword">do</span>
        <span class="keyword">if</span> i &lt; imin <span class="keyword">then</span> imin = i <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">local</span> cmd, append = {}, <span class="global">table</span>.insert
    <span class="keyword">for</span> i = imin,-<span class="number">1</span> <span class="keyword">do</span>
        <span class="keyword">local</span> a = args[i]
        <span class="keyword">if</span> a:match <span class="string">'%s'</span> <span class="keyword">then</span>
            a = <span class="string">'"'</span>..a..<span class="string">'"'</span>
        <span class="keyword">end</span>
        append(cmd,a)
    <span class="keyword">end</span>
    <span class="keyword">return</span> <span class="global">table</span>.concat(cmd,<span class="string">' '</span>),args[imin]
<span class="keyword">end</span>

<span class="comment">--- parse command-line arguments into flags and parameters.
</span><span class="comment">-- Understands GNU-style command-line flags; short (<code>-f</code>) and long (<code>--flag</code>).
</span><span class="comment">-- These may be given a value with either '=' or ':' (<code>-k:2</code>,<code>--alpha=3.2</code>,<code>-n2</code>);
</span><span class="comment">-- note that a number value can be given without a space.
</span><span class="comment">-- Multiple short args can be combined like so: ( <code>-abcd</code>).
</span><span class="comment">-- @tparam {string} args an array of strings (default is the global <code>arg</code>)
</span><span class="comment">-- @tab flags_with_values any flags that take values, e.g. <code>{out=true}</code>
</span><span class="comment">-- @return a table of flags (flag=value pairs)
</span><span class="comment">-- @return an array of parameters
</span><a id="107"></a><span class="comment">-- @raise if args is nil, then the global <code>args</code> must be available!
</span><span class="keyword">function</span> app.parse_args (args,flags_with_values)
    <span class="keyword">if</span> <span class="keyword">not</span> args <span class="keyword">then</span>
        args = _G.arg
        <span class="keyword">if</span> <span class="keyword">not</span> args <span class="keyword">then</span> error <span class="string">"Not in a main program: 'arg' not found"</span> <span class="keyword">end</span>
    <span class="keyword">end</span>
    flags_with_values = flags_with_values <span class="keyword">or</span> {}
    <span class="keyword">local</span> _args = {}
    <span class="keyword">local</span> flags = {}
    <span class="keyword">local</span> i = <span class="number">1</span>
    <span class="keyword">while</span> i &lt;= #args <span class="keyword">do</span>
        <span class="keyword">local</span> a = args[i]
        <span class="keyword">local</span> v = a:match(<span class="string">'^-(.+)'</span>)
        <span class="keyword">local</span> is_long
        <span class="keyword">if</span> v <span class="keyword">then</span> <span class="comment">-- we have a flag
</span>            <span class="keyword">if</span> v:find <span class="string">'^-'</span> <span class="keyword">then</span>
                is_long = <span class="keyword">true</span>
                v = v:sub(<span class="number">2</span>)
            <span class="keyword">end</span>
            <span class="keyword">if</span> flags_with_values[v] <span class="keyword">then</span>
                <span class="keyword">if</span> i == #_args <span class="keyword">or</span> args[i+<span class="number">1</span>]:find <span class="string">'^-'</span> <span class="keyword">then</span>
                    <span class="keyword">return</span> utils.raise (<span class="string">"no value for '"</span>..v..<span class="string">"'"</span>)
                <span class="keyword">end</span>
                flags[v] = args[i+<span class="number">1</span>]
                i = i + <span class="number">1</span>
            <span class="keyword">else</span>
                <span class="comment">-- a value can also be indicated with =
</span>                <span class="keyword">local</span> var,val =  utils.splitv (v,<span class="string">'='</span>)
                var = var <span class="keyword">or</span> v
                val = val <span class="keyword">or</span> <span class="keyword">true</span>
                <span class="keyword">if</span> <span class="keyword">not</span> is_long <span class="keyword">then</span>
                    <span class="keyword">if</span> #var &gt; <span class="number">1</span> <span class="keyword">then</span>
                        <span class="keyword">if</span> var:find <span class="string">'.%d+'</span> <span class="keyword">then</span> <span class="comment">-- short flag, number value
</span>                            val = var:sub(<span class="number">2</span>)
                            var = var:sub(<span class="number">1</span>,<span class="number">1</span>)
                        <span class="keyword">else</span> <span class="comment">-- multiple short flags
</span>                            <span class="keyword">for</span> i = <span class="number">1</span>,#var <span class="keyword">do</span>
                                flags[var:sub(i,i)] = <span class="keyword">true</span>
                            <span class="keyword">end</span>
                            val = <span class="keyword">nil</span> <span class="comment">-- prevents use of var as a flag below
</span>                        <span class="keyword">end</span>
                    <span class="keyword">else</span>  <span class="comment">-- single short flag (can have value, defaults to true)
</span>                        val = val <span class="keyword">or</span> <span class="keyword">true</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                <span class="keyword">if</span> val <span class="keyword">then</span>
                    flags[var] = val
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            _args[#_args+<span class="number">1</span>] = a
        <span class="keyword">end</span>
        i = i + <span class="number">1</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> flags,_args
<span class="keyword">end</span>

<span class="keyword">return</span> app</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2014-11-01 18:36:39 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
